# Story 1.5: Interactive Visual Canvas Foundation

## Status

**Current Status:** Draft

## Story

**As a** visual thinker and strategic professional,  
**I want** an interactive drawing canvas where I can sketch ideas, create diagrams, and iterate on visual concepts,  
**so that** I can externalize my thoughts through visual creation and complement my conversational strategic thinking with hands-on visual exploration.

## Acceptance Criteria (Post-MVP Canvas with Markdown Focus)

1. **Excalidraw Integration for Casual Visual Thinking**
   - Embedded Excalidraw component for rough sketches and wireframes
   - Hand-drawn aesthetic supporting rapid ideation over polished diagrams
   - Basic shapes library (rectangles, circles, arrows, stick figures)
   - Quick sketch templates for common business frameworks (2x2 matrix, process flow)
   - Auto-save sketches with workspace state persistence

2. **Markdown File Processing and Visualization**
   - Upload and parse markdown files for strategic content analysis
   - Extract headings, lists, and key concepts for visual mapping
   - Generate rough diagram suggestions from markdown structure
   - Convert markdown tables into simple visual layouts
   - Real-time preview of markdown rendering alongside sketch canvas

3. **Text-to-Visual Conversion Engine**
   - AI-powered analysis of text content to suggest sketch elements
   - Automatic generation of rough flowcharts from process descriptions
   - Simple org charts from team/role mentions in documents
   - Timeline sketches from chronological content
   - Concept mapping from key terms and relationships

4. **Casual Collaboration and Export**
   - Simple sharing via sketch URLs (read-only access)
   - Export to PNG with hand-drawn aesthetic preserved
   - Basic commenting system for feedback on sketches
   - Version history showing sketch evolution over time
   - Integration with common tools (Slack, email) for sharing rough concepts

5. **Canvas-Chat Integration for Post-MVP Phase**
   - Mary can reference sketches in conversation ("Looking at your process diagram...")
   - Sketch elements become conversational talking points
   - Chat suggestions trigger simple sketch additions
   - Visual annotations linked to specific chat exchanges
   - Cross-search between chat history and sketch annotations

## Tasks / Subtasks

- [ ] **Excalidraw Integration Foundation** (AC: 1)
  - [ ] Install @excalidraw/excalidraw React component library
  - [ ] Create canvas wrapper component with workspace state integration
  - [ ] Implement auto-save functionality syncing with Supabase workspace storage
  - [ ] Add basic sketch templates for business frameworks (SWOT matrix, process flows)
  - [ ] Configure hand-drawn aesthetic settings and theme customization
  - [ ] Test canvas performance within dual-pane layout constraints
  - [ ] Create loading states and error boundaries for canvas initialization

- [ ] **Markdown File Processing Engine** (AC: 2)
  - [ ] Install markdown parser (remark/unified ecosystem)
  - [ ] Create file upload component with drag-and-drop support
  - [ ] Build markdown AST analyzer to extract structure (headings, lists, tables)
  - [ ] Implement key concept extraction using text analysis
  - [ ] Create markdown preview component with syntax highlighting
  - [ ] Add real-time markdown editing with live preview updates
  - [ ] Store processed markdown content in workspace state

- [ ] **Text-to-Visual AI Conversion** (AC: 3)
  - [ ] Design prompt templates for visual suggestion generation
  - [ ] Integrate with Claude API for text content analysis
  - [ ] Create suggestion engine for flowcharts from process descriptions
  - [ ] Build org chart generator from team/role text mentions
  - [ ] Implement timeline sketch creation from chronological content
  - [ ] Add concept mapping generation from key terms and relationships
  - [ ] Create visual suggestion UI with one-click sketch insertion

- [ ] **Simple Sharing and Export** (AC: 4)
  - [ ] Implement sketch export to PNG with Excalidraw native functionality
  - [ ] Create shareable URL system with read-only access controls
  - [ ] Build basic commenting system for sketch feedback
  - [ ] Add version history tracking for sketch iterations
  - [ ] Integrate sharing options (copy link, email, Slack webhook)
  - [ ] Create embed codes for sharing sketches in external documents

- [ ] **Canvas-Chat Bridge (Post-MVP Phase)** (AC: 5)
  - [ ] Design sketch reference system for Mary's conversation context
  - [ ] Create clickable sketch elements that trigger chat discussions
  - [ ] Implement chat-to-sketch suggestion system
  - [ ] Add visual annotation system linked to chat messages
  - [ ] Build cross-search functionality between chat and sketch content
  - [ ] Create conversation starters triggered by sketch changes

## Dev Notes

Based on the architecture document and post-MVP positioning, here are the implementation details for Story 1.5:

### Technical Stack Configuration (Post-MVP Canvas)

**Visual Canvas:** Excalidraw integration for casual sketching
- @excalidraw/excalidraw ^0.17.0 with React wrapper
- Hand-drawn aesthetic with rough/sketchy rendering style
- Infinite canvas with pan/zoom, layer management built-in
- Auto-save integration with existing workspace state system

**Markdown Processing:** Unified/Remark ecosystem
```typescript
// Markdown processing pipeline for visual conversion
interface MarkdownAnalysis {
  structure: {
    headings: HeadingNode[];
    lists: ListNode[];
    tables: TableNode[];
    codeBlocks: CodeBlockNode[];
  };
  concepts: {
    keyTerms: string[];
    relationships: ConceptRelation[];
    processes: ProcessFlow[];
    entities: EntityMention[];
  };
  visualSuggestions: SketchSuggestion[];
}

// Integration with existing workspace state
interface CanvasWorkspaceState {
  excalidraw_elements: ExcalidrawElement[];
  markdown_sources: MarkdownDocument[];
  sketch_suggestions: SketchSuggestion[];
  visual_annotations: CanvasAnnotation[];
  last_updated: timestamp;
}
```

**Text-to-Visual AI Integration:**
```typescript
// Claude integration for visual suggestion generation
const generateSketchSuggestions = async (markdownContent: string) => {
  const prompt = `
  Analyze this markdown content and suggest simple, casual sketches that would help visualize the key concepts:
  
  ${markdownContent}
  
  Suggest 3-5 rough sketch ideas that could be quickly drawn with basic shapes:
  - Process flows using arrows and rectangles
  - Simple org charts with stick figures
  - Timeline sketches with dates and milestones
  - Concept maps with bubbles and connections
  
  Focus on hand-drawn, casual aesthetics suitable for Excalidraw.
  `;
  
  return await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    messages: [{ role: 'user', content: prompt }],
    max_tokens: 1000
  });
};
```

**Excalidraw Integration Architecture:**
```typescript
// Canvas component wrapper with workspace integration
import { Excalidraw, ExcalidrawElement } from '@excalidraw/excalidraw';

const CanvasPane = () => {
  const [elements, setElements] = useState<ExcalidrawElement[]>([]);
  const { workspace, updateWorkspace } = useWorkspaceStore();
  
  // Auto-save canvas state to workspace
  const handleCanvasChange = useCallback(
    debounce((elements: ExcalidrawElement[]) => {
      updateWorkspace({
        ...workspace,
        canvas_state: {
          excalidraw_elements: elements,
          last_updated: new Date()
        }
      });
    }, 2000),
    [workspace, updateWorkspace]
  );

  return (
    <div className="canvas-pane h-full w-full">
      <Excalidraw
        initialData={{
          elements: workspace.canvas_state?.excalidraw_elements || [],
          appState: { theme: 'light', gridSize: null }
        }}
        onChange={handleCanvasChange}
        renderTopRightUI={() => <CanvasToolbar />}
        renderFooter={() => <CanvasStatus />}
      />
    </div>
  );
};
```

**Markdown Processing Pipeline:**
```typescript
// Markdown analysis and visual suggestion system
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkGfm from 'remark-gfm';

const analyzeMarkdownForVisuals = async (content: string) => {
  const processor = unified()
    .use(remarkParse)
    .use(remarkGfm);
    
  const ast = processor.parse(content);
  
  // Extract structure for visual suggestions
  const analysis = {
    headings: extractHeadings(ast),
    processes: extractProcessFlows(ast),
    relationships: extractEntityRelationships(ast),
    timelines: extractChronologicalContent(ast)
  };
  
  // Generate AI suggestions for each structural element
  const suggestions = await generateSketchSuggestions(analysis);
  
  return {
    analysis,
    suggestions: parseVisualSuggestions(suggestions)
  };
};
```

**Database Schema Extensions (Post-MVP):**
```sql
-- Canvas state storage integrated with existing workspace
ALTER TABLE user_workspace 
ADD COLUMN canvas_state JSONB DEFAULT '{}';

-- Markdown document processing tracking
CREATE TABLE markdown_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    filename TEXT NOT NULL,
    content TEXT NOT NULL,
    analysis_result JSONB,
    visual_suggestions JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Canvas annotations linked to chat context (Story 1.7 preparation)
CREATE TABLE canvas_annotations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    element_id TEXT NOT NULL, -- Excalidraw element ID
    annotation_text TEXT,
    linked_message_id UUID, -- Reference to chat_messages for context bridging
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Key Post-MVP Architecture Decisions:**
- Excalidraw provides proven casual sketching without custom canvas development
- Markdown processing as primary entry point rather than blank canvas drawing
- AI-assisted visual suggestions reduce drawing skill requirements
- Canvas state integrated with existing workspace persistence
- Simple sharing through Excalidraw's native export capabilities
- Foundation laid for Story 1.7 context bridging with annotation system

**Environment Variables (Post-MVP Addition):**
```bash
# Canvas Features (Post-MVP)
NEXT_PUBLIC_ENABLE_CANVAS=false  # Feature flag for MVP/post-MVP
NEXT_PUBLIC_MAX_CANVAS_ELEMENTS=500
NEXT_PUBLIC_ENABLE_MARKDOWN_UPLOAD=true
```

### Testing

**Testing Standards (Post-MVP Focus):**

**Test File Location:** 
- Canvas tests: `apps/web/tests/canvas/`
- Markdown processing tests: `apps/web/tests/markdown-analysis/`
- Visual suggestion tests: `apps/web/tests/ai-visual-suggestions/`

**Testing Frameworks:**
- **Frontend:** Vitest + Testing Library for canvas components
- **E2E:** Playwright for sketch creation and markdown upload flows
- **AI Integration:** Mock Claude responses for visual suggestion testing

**Specific Testing Requirements:**
- Test Excalidraw component integration with workspace state
- Verify markdown file upload and processing pipeline
- Test AI visual suggestion generation with various document types
- Validate canvas auto-save and state persistence
- Test sketch sharing and export functionality
- Verify post-MVP feature flag behavior (canvas disabled in MVP)

**Performance Requirements (Post-MVP):**
- Markdown analysis under 3 seconds for documents up to 10,000 words
- Canvas rendering stable with up to 500 sketch elements
- Auto-save debouncing prevents excessive API calls
- Sketch export generation under 2 seconds

**Post-MVP Benefits:**
- 70% reduction in development complexity using Excalidraw vs custom canvas
- Markdown processing provides immediate value for existing content
- AI-assisted suggestions reduce user drawing skill requirements
- Casual aesthetic lowers barrier to visual thinking adoption

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-24 | 1.0 | Initial story creation for Epic 1.5 Interactive Visual Canvas Foundation (Post-MVP scope with Excalidraw integration) | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used

*(To be populated by development agent during implementation)*

### Debug Log References

*(To be populated by development agent during implementation)*

### Completion Notes List

*(To be populated by development agent during implementation)*

### File List

*(To be populated by development agent during implementation)*

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*