# Story 5.7: Workspace Refinement

## Status
Ready for Development

## Story
**As a** user conducting strategic sessions in the workspace,
**I want** a refined dual-pane interface with improved typography and cleaner styling,
**so that** I can focus on strategic thinking without visual distractions.

## Acceptance Criteria

### Functional Requirements
1. **Compact Header**: Reduced header height with cleaner tab navigation
2. **Refined Chat Messages**: Better spacing, typography, and message bubbles for user and assistant
3. **Improved Avatars**: Clear avatar differentiation between user and assistant (initials or icons)
4. **Enhanced Markdown**: Better typography for markdown-rendered content in messages
5. **Clean Canvas Toolbar**: Simplified toolbar with icon buttons and subtle dividers
6. **Better Message Spacing**: Generous whitespace between messages for readability

### Integration Requirements
7. Existing chat functionality works unchanged (message sending, streaming)
8. Canvas pane maintains current tldraw integration
9. Tab navigation preserves existing routes (Chat, Canvas, Export)
10. Message persistence and session state management unchanged

### Quality Requirements
11. Chat interface is accessible via keyboard
12. Message typography is readable with proper contrast
13. Canvas toolbar icons are clear and properly labeled
14. Responsive layout works on tablet and desktop (mobile not critical for workspace)

## Tasks / Subtasks

- [ ] **Task 1: Header Refinement** (AC: 1)
  - [ ] Subtask 1.1: Reduce header height (from current to ~56px)
  - [ ] Subtask 1.2: Simplify tab navigation styling (underline active tab)
  - [ ] Subtask 1.3: Clean up session title display
  - [ ] Subtask 1.4: Improve session actions menu styling

- [ ] **Task 2: Chat Message Redesign** (AC: 2, 3, 6)
  - [ ] Subtask 2.1: Redesign user messages (right-aligned, blue background)
  - [ ] Subtask 2.2: Redesign assistant messages (left-aligned, gray background)
  - [ ] Subtask 2.3: Add clear avatar components with differentiation
  - [ ] Subtask 2.4: Increase message spacing (24px vertical gap minimum)
  - [ ] Subtask 2.5: Improve message bubble padding and border radius

- [ ] **Task 3: Typography and Markdown** (AC: 4, 12)
  - [ ] Subtask 3.1: Apply new typography system to message content
  - [ ] Subtask 3.2: Style markdown headings with DM Sans bold
  - [ ] Subtask 3.3: Improve code block styling (DM Mono, subtle background)
  - [ ] Subtask 3.4: Enhance list and table typography
  - [ ] Subtask 3.5: Ensure proper contrast for all text elements

- [ ] **Task 4: Canvas Toolbar Cleanup** (AC: 5, 13)
  - [ ] Subtask 4.1: Simplify toolbar design (icon buttons, subtle background)
  - [ ] Subtask 4.2: Add subtle dividers between tool groups
  - [ ] Subtask 4.3: Ensure icon clarity and proper tooltips
  - [ ] Subtask 4.4: Reduce toolbar visual weight

- [ ] **Task 5: Dual-Pane Layout Polish** (AC: 9, 10, 14)
  - [ ] Subtask 5.1: Verify split pane behavior works correctly
  - [ ] Subtask 5.2: Test tab navigation and routing
  - [ ] Subtask 5.3: Ensure responsive behavior on tablet
  - [ ] Subtask 5.4: Validate session state persistence

- [ ] **Task 6: Accessibility and Testing** (AC: 7, 8, 11)
  - [ ] Subtask 6.1: Test keyboard navigation through messages
  - [ ] Subtask 6.2: Verify screen reader accessibility
  - [ ] Subtask 6.3: Test chat streaming and message sending
  - [ ] Subtask 6.4: Validate canvas integration unchanged

## Dev Notes

### Previous Story Dependencies
**Requires Stories 5.1 and 5.2 Completion**: Design system and fonts must be in place for typography improvements.

### Previous Story Insights
From Stories 5.1-5.2:
- Design tokens available (colors, spacing, typography)
- DM Sans for message content, DM Mono for code
- Minimal aesthetic with subtle backgrounds
- Focus on clarity and generous whitespace

### Page Structure

**Workspace Layout [Source: Original plan Section 5]:**

```
┌──────────────────────────────────────────────┐
│  Header (compact, 56px)                      │
│  Session Title | Chat | Canvas | Export      │  ← Tab navigation
├──────────────────────┬───────────────────────┤
│                      │                       │
│  Chat Pane           │  Canvas Pane          │
│                      │                       │
│  ┌────────────────┐  │  [Toolbar]            │
│  │  Assistant Msg │  │                       │
│  └────────────────┘  │  [Canvas Area]        │
│                      │                       │
│      ┌────────────┐  │                       │
│      │  User Msg  │  │                       │
│      └────────────┘  │                       │
│                      │                       │
│  ┌────────────────┐  │                       │
│  │  Assistant Msg │  │                       │
│  └────────────────┘  │                       │
│                      │                       │
│  [Input box]         │                       │
└──────────────────────┴───────────────────────┘
```

### Component Specifications

**Header:**
- Height: 56px (reduced from current)
- Background: white
- Border bottom: 1px solid #e5e5e5
- Session title: Left side, text-lg, bold
- Tabs: Right side, underline style for active tab

**Tab Navigation:**
- Style: Minimal, underline active tab
- Active: Border bottom 2px solid #0079ff
- Inactive: No border, muted text
- Hover: Subtle background change

**Chat Message - User:**
- Alignment: Right-aligned
- Background: #0079ff (primary blue)
- Text color: White
- Max-width: 70% of pane
- Border radius: 12px (rounded)
- Padding: 12px 16px
- Avatar: Right side, user initials or icon

**Chat Message - Assistant:**
- Alignment: Left-aligned
- Background: #f9f9f9 (subtle gray)
- Text color: #191919 (foreground)
- Max-width: 70% of pane
- Border radius: 12px (rounded)
- Padding: 12px 16px
- Avatar: Left side, "M" for Mary or assistant icon

**Message Spacing:**
- Vertical gap: 24px between messages
- Padding: 32px container padding (top, sides, bottom)
- Input box: Sticky at bottom, 16px margin

**Avatar:**
- Size: 32px circle
- User: Initials in primary blue circle
- Assistant: "M" or brain icon in gray circle
- Position: Aligned with message top

**Markdown Typography:**
- Headings: DM Sans bold, larger sizes
- Body: DM Sans regular, 16px
- Code inline: DM Mono, subtle background
- Code blocks: DM Mono, #f9f9f9 background, border
- Lists: Proper spacing and indentation
- Tables: Subtle borders, alternating row backgrounds

**Canvas Toolbar:**
- Background: #f9f9f9 (subtle)
- Border bottom: 1px solid #e5e5e5
- Height: 48px
- Buttons: Icon only, no text labels
- Dividers: 1px vertical lines between tool groups
- Tooltips: On hover, clear descriptions

**Input Box:**
- Height: Auto-expanding (min 48px, max 200px)
- Border: 1px solid #e5e5e5
- Border radius: 8px
- Padding: 12px 16px
- Focus: Border #0079ff
- Send button: Icon button, primary color

### File Locations

**Files to Modify:**
- `/apps/web/app/workspace/[id]/page.tsx` - Workspace layout and styling
- `/apps/web/app/components/chat/*` - Chat message components (if separate)
- `/apps/web/app/components/canvas/*` - Canvas toolbar components (if separate)

**Related Files (reference only):**
- `/apps/web/lib/ai/streaming.ts` - Chat streaming (no changes)
- `/apps/web/lib/canvas/canvas-manager.ts` - Canvas logic (no changes)
- `/apps/web/app/components/DualPaneLayout.tsx` - Layout component (possibly modify)

### Technical Implementation Details

**Implementation Approach [Source: Original plan Section 5]:**
1. **Header reduction** - Compact header with cleaner tabs
2. **Message bubbles** - Redesign with better colors and spacing
3. **Avatar improvements** - Clear differentiation between user and assistant
4. **Markdown styling** - Enhanced typography for rendered content
5. **Canvas toolbar** - Simplified visual design

**Chat Message Rendering:**
```typescript
// Example structure
<div className="flex gap-3 mb-6">
  <Avatar type="assistant" />
  <div className="message-bubble assistant">
    <ReactMarkdown>{content}</ReactMarkdown>
  </div>
</div>

<div className="flex gap-3 mb-6 justify-end">
  <div className="message-bubble user">
    {content}
  </div>
  <Avatar type="user" />
</div>
```

**Markdown Styling:**
- Use `react-markdown` with custom components
- Style headings, code blocks, lists, tables
- Ensure syntax highlighting for code (if applicable)
- Proper spacing between markdown elements

**Canvas Toolbar Icons:**
- Use Lucide React icons for consistency
- Tooltips: "Select", "Pan", "Draw", "Text", "Shapes"
- Group tools logically (selection | drawing | objects)
- Minimize visual weight (icons only, subtle background)

### Performance Requirements

- **Message Rendering**: Smooth rendering with 100+ messages
- **Markdown Parsing**: < 100ms for typical messages
- **Canvas Operations**: No regression from current performance

### Testing Requirements

**Testing Standards [Source: architecture/testing-strategy.md]:**
- E2E testing for chat and canvas interactions
- Accessibility audit for keyboard navigation
- Visual validation for message styling

**Specific Test Scenarios:**

1. **Chat Functionality:**
   - User can send messages successfully
   - Assistant responses stream correctly
   - Message bubbles render with correct styling
   - Avatars display correctly for user and assistant
   - Markdown content renders properly

2. **Canvas Functionality:**
   - Toolbar buttons trigger correct actions
   - Canvas pane displays tldraw correctly
   - Tab navigation switches between Chat and Canvas
   - Export tab functions unchanged

3. **Responsive Testing:**
   - Desktop (1440px): Full dual-pane layout
   - Tablet (1024px): Dual-pane with reduced widths
   - Note: Mobile workspace not critical (desktop-focused tool)

4. **Accessibility Testing:**
   - Keyboard navigation through messages
   - Tab key moves focus correctly
   - Screen reader announces messages properly
   - Color contrast meets WCAG 2.1 AA

5. **Typography Testing:**
   - DM Sans renders correctly in messages
   - DM Mono renders correctly in code blocks
   - Headings have proper hierarchy
   - Line spacing is readable

### Technical Constraints

**Integration Requirements [Source: Epic 5 dependencies]:**
- Must preserve existing chat streaming logic
- Must maintain current canvas tldraw integration
- Must not break message persistence
- Must keep session state management unchanged

**Scope Limitations:**
- Visual refinement only - no functional changes
- No new chat features or canvas tools
- No changes to AI integration or message handling
- Focus on typography, spacing, and visual polish

## Testing

### Testing Standards
- **E2E**: Playwright tests for workspace flows
- **Unit**: Component tests for message rendering
- **Accessibility**: axe DevTools scan
- **Visual**: Markdown rendering validation

### Specific Testing Requirements

1. **E2E Test Cases:**
   ```typescript
   test('user can send message and receive response', async ({ page }) => {
     await page.goto('/workspace/[session-id]');
     await page.fill('[data-testid="chat-input"]', 'Test message');
     await page.click('[data-testid="send-button"]');
     await expect(page.locator('.message-bubble.user')).toContainText('Test message');
     await expect(page.locator('.message-bubble.assistant')).toBeVisible();
   });

   test('tab navigation switches between Chat and Canvas', async ({ page }) => {
     await page.goto('/workspace/[session-id]');
     await page.click('text=Canvas');
     await expect(page.locator('[data-testid="canvas-pane"]')).toBeVisible();
     await page.click('text=Chat');
     await expect(page.locator('[data-testid="chat-pane"]')).toBeVisible();
   });
   ```

2. **Markdown Rendering Tests:**
   - Headings render with correct styles
   - Code blocks have DM Mono font and background
   - Lists have proper indentation
   - Tables render with borders and spacing
   - Links are underlined and clickable

3. **Visual Regression:**
   - Message bubbles match design specs
   - Avatar positioning is correct
   - Spacing between messages is generous
   - Toolbar is compact and clean

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-12-21 | 1.0 | Initial story creation for workspace refinement | John (Product Manager) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA Agent upon story completion*
