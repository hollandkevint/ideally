# Story 2.6: Canvas Visual Workspace Implementation

## Status
⏳ In Progress - Phase 2 Complete (2025-09-30)

**Completion Status**: ~50% Complete (Phase 2 of 7)
- ✅ Phase 1: Foundational Architecture (Day 1) - COMPLETE
  - Dual-pane layout with resizable divider (295 lines)
  - Canvas workspace component with toolbar (285 lines)
  - Canvas state manager for persistence (255 lines)
  - API endpoints for save/load/export (70+ lines)
- ✅ Phase 2: Canvas Library Integration & Mermaid.js (Day 2) - COMPLETE
  - tldraw integration with auto-save (100 lines)
  - Mermaid renderer with error handling (75 lines)
  - Mermaid editor with 6 templates (150 lines)
  - Enhanced workspace with mode switching (150 lines)
  - npm packages: tldraw@4.0.2, mermaid@11.12.0
- ⏳ Phase 3: Context Synchronization - PENDING
- ⏳ Phase 4: Advanced Export System - PENDING
- ⏳ Phase 5: Testing & Optimization - PENDING

## Implementation Priority
**Priority**: High
**Dependencies**: Stories 2.1-2.5 (BMAD pathways foundation)
**Estimated Effort**: 5-7 days
**Complexity**: High

## Story
**As a** user engaged in strategic thinking sessions,
**I want** a visual canvas workspace synchronized with my AI coaching conversations,
**so that** I can create diagrams, wireframes, and visual representations of my ideas in real-time alongside the conversational coaching experience.

## Acceptance Criteria
1. **Dual-Pane Interface**: Split-screen layout with chat coaching (left) and visual canvas (right) that maintains responsive behavior
2. **Real-time Wireframing**: Basic shapes, annotations, connectors, and user flow diagramming tools with intuitive UX
3. **Context Synchronization**: Ideas and insights from conversation automatically populate or suggest canvas elements
4. **Mermaid.js Integration**: Support for workflow diagrams, decision trees, and process visualization with code-to-visual conversion
5. **Canvas Export**: Export capabilities for PNG, SVG formats and Mermaid code sharing
6. **State Persistence**: Canvas workspace state synchronized with session state across refreshes and pathway switches

## Tasks / Subtasks

- [ ] Task 1: Implement Dual-Pane Layout Architecture (AC: 1)
  - [ ] Subtask 1.1: Design responsive split-screen layout with adjustable divider
  - [ ] Subtask 1.2: Implement chat pane integration with existing AI coaching interface
  - [ ] Subtask 1.3: Create canvas pane container with proper state management
  - [ ] Subtask 1.4: Add mobile-responsive behavior (stacked panes with tab switching)

- [ ] Task 2: Build Canvas Drawing Tools (AC: 2)
  - [ ] Subtask 2.1: Integrate canvas library (evaluate Fabric.js, Konva, or Excalidraw)
  - [ ] Subtask 2.2: Implement basic shapes (rectangles, circles, lines, arrows)
  - [ ] Subtask 2.3: Add text annotations and labels with formatting options
  - [ ] Subtask 2.4: Create connector tools for flowcharts and user flows
  - [ ] Subtask 2.5: Implement selection, move, resize, and delete operations
  - [ ] Subtask 2.6: Add undo/redo functionality

- [ ] Task 3: Develop Context Synchronization Engine (AC: 3)
  - [ ] Subtask 3.1: Create intelligent parsing of AI responses for visual suggestions
  - [ ] Subtask 3.2: Implement auto-population of canvas elements from conversation insights
  - [ ] Subtask 3.3: Add bidirectional sync (canvas annotations back to chat context)
  - [ ] Subtask 3.4: Create suggestion system for relevant diagram types based on conversation

- [ ] Task 4: Integrate Mermaid.js for Diagrams (AC: 4)
  - [ ] Subtask 4.1: Add Mermaid.js library with rendering engine
  - [ ] Subtask 4.2: Implement code editor with syntax highlighting for Mermaid syntax
  - [ ] Subtask 4.3: Create workflow diagram templates (flowchart, sequence, gantt, etc.)
  - [ ] Subtask 4.4: Add visual-to-code and code-to-visual conversion features
  - [ ] Subtask 4.5: Implement collaborative editing of Mermaid diagrams

- [ ] Task 5: Build Export System (AC: 5)
  - [ ] Subtask 5.1: Implement PNG export with configurable resolution
  - [ ] Subtask 5.2: Add SVG export for scalable graphics
  - [ ] Subtask 5.3: Create Mermaid code export and sharing functionality
  - [ ] Subtask 5.4: Add clipboard copy for quick sharing
  - [ ] Subtask 5.5: Implement export with session metadata and branding

- [ ] Task 6: Canvas State Persistence (AC: 6)
  - [ ] Subtask 6.1: Extend session state schema to include canvas data
  - [ ] Subtask 6.2: Implement real-time canvas state serialization
  - [ ] Subtask 6.3: Add auto-save functionality (every 30 seconds)
  - [ ] Subtask 6.4: Create canvas recovery from saved state
  - [ ] Subtask 6.5: Integrate with universal session state manager (Story 2.5)

- [ ] Task 7: Testing & Performance Optimization (All ACs)
  - [ ] Subtask 7.1: Unit tests for canvas operations and state management
  - [ ] Subtask 7.2: Integration tests for chat-canvas synchronization
  - [ ] Subtask 7.3: E2E tests for complete dual-pane workflow
  - [ ] Subtask 7.4: Performance optimization for large canvases (60fps target)
  - [ ] Subtask 7.5: Browser compatibility testing (Chrome, Firefox, Safari, Edge)

## Dev Notes

### Previous Story Dependencies
**Requires Stories 2.1-2.5 Foundation**:
- BMAD pathway orchestration established (Stories 2.1-2.4)
- Universal session state management (Story 2.5)
- AI conversation context management (Story 1.4)
- Database schema for session persistence

### Canvas Library Evaluation

**Option 1: Fabric.js**
- Pros: Mature, powerful canvas manipulation, large community
- Cons: Larger bundle size, steeper learning curve
- Best for: Complex drawing applications

**Option 2: Konva**
- Pros: Good performance, React integration, simpler API
- Cons: Less feature-rich than Fabric.js
- Best for: Balanced features and performance

**Option 3: Excalidraw**
- Pros: Beautiful hand-drawn aesthetic, collaborative features, open source
- Cons: Opinionated design, less customizable
- Best for: Quick wireframes and sketches

**Option 4: tldraw**
- Pros: Modern, lightweight, excellent React integration, infinite canvas
- Cons: Relatively new, smaller community
- Best for: Collaborative whiteboard experience

**Recommendation**: **tldraw** for initial implementation (modern, React-native, great UX)

### Data Models

**Canvas Workspace Schema** [Source: extending universal session state from Story 2.5]:
```sql
-- Extend bmad_sessions for canvas data
ALTER TABLE bmad_sessions ADD COLUMN IF NOT EXISTS
  canvas_data jsonb DEFAULT '{}', -- Canvas workspace state
  canvas_history jsonb DEFAULT '[]', -- Undo/redo history
  mermaid_diagrams jsonb DEFAULT '[]'; -- Stored Mermaid diagrams

-- Canvas snapshots for version control
CREATE TABLE bmad_canvas_snapshots (
  id uuid default uuid_generate_v4() primary key,
  session_id uuid references bmad_sessions(id) on delete cascade,
  snapshot_type text check (snapshot_type in ('auto_save', 'manual_save', 'export')),
  canvas_state jsonb not null,
  thumbnail_url text,
  created_at timestamptz default now()
);
```

**Canvas State Structure**:
```typescript
interface CanvasWorkspace {
  id: string;
  sessionId: string;
  elements: CanvasElement[];
  mermaidDiagrams: MermaidDiagram[];
  viewport: Viewport;
  metadata: CanvasMetadata;
}

interface CanvasElement {
  id: string;
  type: 'shape' | 'text' | 'connector' | 'image';
  position: { x: number; y: number };
  dimensions: { width: number; height: number };
  style: ElementStyle;
  data: any;
  linkedToConversation?: string; // Message ID from chat
}

interface MermaidDiagram {
  id: string;
  code: string;
  type: 'flowchart' | 'sequence' | 'gantt' | 'class' | 'state';
  position: { x: number; y: number };
  generatedFrom?: string; // AI suggestion or manual
}

interface Viewport {
  zoom: number;
  pan: { x: number; y: number };
}
```

### API Specifications

**Canvas Management Endpoints** [Source: extending /api/bmad pattern]:
- `POST /api/bmad` with `action: 'save_canvas_state'` - Save canvas workspace
- `POST /api/bmad` with `action: 'load_canvas_state'` - Retrieve canvas state
- `POST /api/bmad` with `action: 'export_canvas'` - Export canvas (PNG/SVG/Mermaid)
- `POST /api/bmad` with `action: 'suggest_diagram'` - AI-powered diagram suggestions
- `POST /api/bmad` with `action: 'sync_canvas_chat'` - Synchronize canvas with chat context

**Canvas Context Synchronization**:
```typescript
interface ContextSyncEngine {
  extractVisualConcepts(message: string): VisualConcept[];
  suggestDiagramType(conversation: ConversationContext): DiagramType;
  populateCanvasFromInsights(insights: string[]): CanvasElement[];
  linkCanvasToConversation(elementId: string, messageId: string): void;
}
```

### Component Specifications

**New Components Required**:
- `/apps/web/app/components/canvas/CanvasWorkspace.tsx` - Main canvas container
- `/apps/web/app/components/canvas/DrawingTools.tsx` - Toolbar with drawing tools
- `/apps/web/app/components/canvas/MermaidEditor.tsx` - Mermaid diagram editor
- `/apps/web/app/components/canvas/CanvasExport.tsx` - Export modal and functionality
- `/apps/web/app/components/canvas/ContextSyncPanel.tsx` - Chat-canvas sync UI
- `/apps/web/app/components/layout/DualPaneLayout.tsx` - Split-screen container
- `/apps/web/app/components/canvas/CanvasElementLibrary.tsx` - Pre-made shapes/templates

**Enhanced Components**:
- `/apps/web/app/components/bmad/BmadInterface.tsx` - Integrate dual-pane layout
- `/apps/web/app/components/chat/ChatInterface.tsx` - Add canvas sync indicators
- `/apps/web/lib/bmad/session-orchestrator.ts` - Canvas state integration

### File Locations

**New Files to Create**:
- `/apps/web/lib/canvas/canvas-manager.ts` - Canvas state management
- `/apps/web/lib/canvas/context-sync-engine.ts` - Chat-canvas synchronization
- `/apps/web/lib/canvas/mermaid-integration.ts` - Mermaid.js wrapper
- `/apps/web/lib/canvas/export-service.ts` - Canvas export utilities
- `/apps/web/lib/canvas/diagram-suggestions.ts` - AI-powered diagram recommendations

**Files to Modify**:
- `/apps/web/app/api/bmad/route.ts` - Add canvas management actions
- `/apps/web/lib/bmad/types.ts` - Add canvas types
- `/apps/web/lib/bmad/session-orchestrator.ts` - Canvas state integration

### Technical Implementation Details

**Dual-Pane Layout Architecture**:
1. **Desktop Layout**: Side-by-side panes with resizable divider (default 50/50 split)
2. **Tablet Layout**: Stacked panes with tab navigation
3. **Mobile Layout**: Single pane with bottom drawer for canvas access
4. **State Management**: Zustand or React Context for pane state

**Canvas Performance Optimization**:
- Virtualization for large canvases (render only visible elements)
- Debounced auto-save (500ms delay after last edit)
- Efficient serialization (exclude non-essential data)
- Web Workers for export operations
- Canvas rendering optimization (requestAnimationFrame)

**Mermaid.js Integration Strategy**:
```typescript
// Mermaid rendering with fallback
const renderMermaid = async (code: string): Promise<string> => {
  try {
    const { svg } = await mermaid.render('diagram-id', code);
    return svg;
  } catch (error) {
    return generateErrorDiagram(error);
  }
};

// Diagram type detection from conversation
const detectDiagramType = (context: ConversationContext): DiagramType => {
  const keywords = {
    flowchart: ['process', 'workflow', 'steps', 'flow'],
    sequence: ['interaction', 'communication', 'sequence'],
    gantt: ['timeline', 'schedule', 'roadmap'],
    class: ['structure', 'model', 'entities'],
  };
  // Match keywords to suggest diagram type
};
```

**Context Synchronization Logic**:
```typescript
// Extract visual concepts from AI responses
const extractVisualConcepts = (message: string): VisualConcept[] => {
  // NLP-based extraction of entities, relationships, processes
  // Example: "The user journey flows from signup to dashboard"
  // Extract: ["user journey", "signup", "dashboard", "flow"]
};

// Auto-suggest canvas additions
const suggestCanvasElements = (concepts: VisualConcept[]): CanvasElement[] => {
  return concepts.map(concept => ({
    type: inferElementType(concept),
    label: concept.text,
    suggestedPosition: calculatePosition(),
    confidence: concept.relevance
  }));
};
```

### Performance Requirements

**Canvas Performance Standards** [Source: NFR1-NFR5 from PRD]:
- Canvas rendering: 60fps during interactions
- Element manipulation: <16ms response time
- State save: <500ms
- State load: <1 second
- Export generation: <5 seconds (PNG), <3 seconds (SVG)
- Mermaid rendering: <2 seconds per diagram

### Testing Requirements

**Testing Standards**:
- Unit tests: `/apps/web/tests/components/canvas/`
- Integration tests: `/apps/web/tests/integration/canvas-integration.test.ts`
- E2E tests: `/apps/web/tests/e2e/dual-pane-workflow.test.ts`
- Performance tests: `/apps/web/tests/performance/canvas-rendering.test.ts`
- Coverage: Minimum 80% for canvas logic

**Specific Test Scenarios**:
- Dual-pane layout responsiveness across devices
- Canvas drawing operations (create, select, move, resize, delete)
- Chat-canvas synchronization accuracy
- Mermaid diagram rendering and editing
- Export functionality for all formats
- State persistence and recovery
- Performance under load (large canvases, complex diagrams)

### Accessibility Considerations

**Canvas Accessibility Requirements** [Source: NFR17-NFR19]:
- Keyboard navigation for all canvas operations
- Screen reader support for canvas element descriptions
- High contrast mode for visual elements
- Focus indicators for selected elements
- Alternative text for exported images

### Integration with Existing Features

**Universal Session State Integration** [Source: Story 2.5]:
- Canvas state included in universal session state
- Pathway switching preserves canvas work
- Backup and recovery includes canvas snapshots
- Analytics track canvas usage patterns

**AI Coaching Integration** [Source: Story 1.4]:
- AI suggestions for relevant diagram types
- Conversation insights auto-populate canvas
- Canvas annotations enhance conversation context
- Export includes both chat and canvas content

## Testing

### Testing Standards
- **Test Location**: `/apps/web/tests/components/canvas/`
- **Integration Tests**: `/apps/web/tests/integration/`
- **E2E Tests**: `/apps/web/tests/e2e/` with Playwright
- **Performance Tests**: `/apps/web/tests/performance/`
- **Coverage**: Minimum 80% code coverage for canvas logic

### Specific Testing Requirements
- Dual-pane layout rendering across viewport sizes
- Canvas drawing tool functionality and accuracy
- Context synchronization between chat and canvas
- Mermaid diagram generation and rendering
- Export functionality for PNG, SVG, and Mermaid code
- State persistence and recovery from session state
- Performance benchmarking (60fps target)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation - Canvas visual workspace for dual-pane strategic thinking interface | Bob (Scrum Master) |

## Implementation Plan

### Phase 1: Dual-Pane Layout (Day 1)
**Files to Create:**
- `app/components/layout/DualPaneLayout.tsx` - Responsive split-screen
- `app/components/canvas/CanvasWorkspace.tsx` - Canvas container

**Key Features:**
- Resizable divider with mouse/touch support
- Responsive breakpoints (desktop/tablet/mobile)
- State persistence for pane sizes

### Phase 2: Canvas Drawing Tools (Day 2-3)
**Library Integration:**
- Install and configure tldraw
- Create custom toolbar
- Implement basic shapes and connectors

**Key Functions:**
```typescript
function createShape(type: ShapeType, position: Position): CanvasElement
function selectElement(id: string): void
function deleteElements(ids: string[]): void
function exportCanvas(format: 'png' | 'svg'): Promise<Blob>
```

### Phase 3: Mermaid.js Integration (Day 3-4)
**Files to Create:**
- `lib/canvas/mermaid-integration.ts`
- `app/components/canvas/MermaidEditor.tsx`

**Diagram Templates:**
- Flowchart
- Sequence diagram
- Gantt chart
- Class diagram

### Phase 4: Context Synchronization (Day 4-5)
**Files to Create:**
- `lib/canvas/context-sync-engine.ts`
- `app/components/canvas/ContextSyncPanel.tsx`

**Sync Features:**
- Extract visual concepts from AI responses
- Suggest relevant diagram types
- Auto-populate canvas elements
- Bidirectional context linking

### Phase 5: State Persistence & Export (Day 6)
**Database:**
- Canvas state schema updates
- Auto-save implementation
- Snapshot management

**Export:**
- PNG with metadata
- SVG for scalability
- Mermaid code sharing

### Phase 6: Testing & Optimization (Day 7)
**Testing:**
- Unit tests for canvas operations
- Integration tests for sync engine
- E2E tests for dual-pane workflow
- Performance optimization

**Optimization:**
- Canvas virtualization
- Export performance
- Bundle size optimization

## Dev Agent Record

### Implementation Checklist
- [ ] Dual-pane layout with responsive behavior
- [ ] Canvas library integration (tldraw)
- [ ] Drawing tools (shapes, text, connectors)
- [ ] Selection and manipulation operations
- [ ] Undo/redo functionality
- [ ] Mermaid.js integration
- [ ] Mermaid editor with syntax highlighting
- [ ] Diagram template library
- [ ] Context synchronization engine
- [ ] AI-powered diagram suggestions
- [ ] PNG export
- [ ] SVG export
- [ ] Mermaid code export
- [ ] Canvas state persistence
- [ ] Auto-save functionality
- [ ] Session state integration (Story 2.5)
- [ ] Unit tests (80%+ coverage)
- [ ] Integration tests
- [ ] E2E tests with Playwright
- [ ] Performance optimization (60fps)

### Technical Notes
**Canvas Library Selection:**
- Primary: tldraw (modern, React-native, great UX)
- Fallback: Excalidraw (if tldraw doesn't meet needs)

**Context Sync Strategy:**
- NLP-based concept extraction
- Keyword matching for diagram type suggestions
- Confidence scoring for auto-population
- User confirmation for major changes

**Performance Targets:**
- 60fps canvas rendering
- <500ms state save
- <5s export generation
- Virtualization for 100+ elements

## QA Results

*This section will be populated by the QA Agent upon story completion*