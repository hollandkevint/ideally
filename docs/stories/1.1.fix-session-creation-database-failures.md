# Story 1.1: Fix Session Creation Database Failures

## Status
Approved

## Story
**As a** user attempting to use the BMad Method,
**I want** session creation to work reliably without database errors,
**so that** I can successfully complete strategic thinking workflows without encountering "Unknown error" failures.

## Acceptance Criteria
1. Session creation operations succeed 100% of the time in localhost testing
2. Database errors in `BmadDatabase.createSession()` are resolved and return meaningful error messages
3. Database errors in `BmadDatabase.getUserSessions()` are resolved and return meaningful error messages  
4. POST `/api/bmad` calls for session creation return success responses instead of 500 errors
5. GET `/api/bmad?action=sessions` calls return active sessions without failures
6. Error logging provides specific details about database operation failures for debugging
7. All existing chat functionality remains intact and unaffected

## Tasks / Subtasks

- [x] **Task 1: Investigate Database Connection Issues** (AC: 1, 2, 3)
  - [x] 1.1 Analyze error patterns in `lib/bmad/database.ts:482` (getUserSessions method)
  - [x] 1.2 Analyze error patterns in `lib/bmad/session-orchestrator.ts:128` (createSession method)  
  - [x] 1.3 Verify Supabase client initialization in database operations
  - [x] 1.4 Test database connectivity and authentication with sample queries
  - [x] 1.5 Check for missing database schema elements or migration issues

- [x] **Task 2: Fix Session Creation Database Operations** (AC: 2, 4)
  - [x] 2.1 Debug and fix `BmadDatabase.createSession()` method implementation
  - [x] 2.2 Ensure proper error handling with specific error messages instead of "Unknown error"
  - [x] 2.3 Validate required database fields are being populated correctly
  - [x] 2.4 Test session creation with various pathway types and configurations
  - [x] 2.5 Add proper transaction handling for session creation operations

- [x] **Task 3: Fix Session Retrieval Database Operations** (AC: 3, 5)
  - [x] 3.1 Debug and fix `BmadDatabase.getUserSessions()` method implementation
  - [x] 3.2 Ensure proper query parameters and filtering for active sessions
  - [x] 3.3 Verify Row Level Security (RLS) policies are not blocking valid queries
  - [x] 3.4 Test session retrieval with various user and workspace combinations
  - [x] 3.5 Optimize query performance and add proper indexing if needed

- [x] **Task 4: Enhance API Error Handling** (AC: 4, 5, 6)
  - [x] 4.1 Improve error handling in `/api/bmad/route.ts` for POST operations
  - [x] 4.2 Improve error handling in `/api/bmad/route.ts` for GET operations
  - [x] 4.3 Add detailed logging for all database operation failures
  - [x] 4.4 Ensure proper HTTP status codes and error response format
  - [x] 4.5 Add request validation and parameter checking

- [x] **Task 5: Testing and Verification** (AC: 1, 7)
  - [x] 5.1 Unit tests for database operations (createSession, getUserSessions)
  - [x] 5.2 Integration tests for API endpoints with various scenarios
  - [x] 5.3 End-to-end testing of complete BMad session workflow
  - [x] 5.4 Regression testing of existing chat functionality
  - [x] 5.5 Load testing to ensure stability under multiple session operations

## Dev Notes

### Epic Context
[Source: docs/current/bmad-method/BMAD-MVP-ROADMAP.md]
**Epic 1: Dual-Pane Strategic Workspace Foundation** - COMPLETE
This story addresses critical database failures discovered post-MVP deployment that prevent users from creating BMad Method sessions. While Epic 1 is marked complete, these session creation failures are blocking production usage and must be resolved immediately.

### Previous Story Insights
This is the first remediation story addressing production issues discovered after Epic 1 completion.

### Database Schema and Integration Points
[Source: docs/current/technical-reference/DATABASE_DEPLOYMENT.md, docs/current/technical-reference/SUPABASE-SETUP-GUIDE.md]

**Database Configuration:**
- **Supabase Project:** `lbnhfsocxbwhbvnfpjdw`
- **Database:** PostgreSQL with complete BMad Method schema (12 tables)
- **Schema File:** `supabase/migrations/001_bmad_method_schema.sql`
- **Status:** Production configured and operational

**Primary Tables Affected:**
- `bmad_sessions` - Session lifecycle and metadata storage
- `bmad_phase_allocations` - Time tracking per phase  
- `bmad_session_progress` - Granular progress metrics
- `bmad_user_responses` - User input storage

**Security Features:**
- Row Level Security (RLS) policies active for user data isolation
- Authentication required for all BMad endpoints
- Foreign key constraints ensuring data integrity

### API Specifications
[Source: Analysis of /Users/kthkellogg/Documents/GitHub/ideally.co/app/api/bmad/route.ts]

**Affected Endpoints:**
- `POST /api/bmad` with `action: create_session`
- `GET /api/bmad?action=sessions&workspaceId={id}&status=active`

**Expected Request/Response Formats:**
- Session creation requires: `{ workspaceId, pathway, initialContext? }`
- Session retrieval filters by: `userId`, `workspaceId`, `status`
- Success responses follow: `{ success: true, data: {...} }` format
- Error responses should provide meaningful error messages

**Error Message Examples:**
```json
// Instead of: "Unknown error"
// Use specific messages:
{ 
  "error": "Database connection failed: Unable to connect to Supabase",
  "code": "DB_CONNECTION_ERROR",
  "details": "Connection timeout after 5000ms"
}

{
  "error": "Session creation failed: User not authenticated",
  "code": "AUTH_REQUIRED",
  "details": "Valid authentication token required for session creation"
}

{
  "error": "Session creation failed: Invalid pathway type",
  "code": "INVALID_PATHWAY",
  "details": "Pathway must be one of: new_idea, stuck_problem, refine_concept"
}
```

### Component Integration Points
[Source: Analysis of apps/web/app/components/bmad/BmadInterface.tsx]

**UI Components Affected:**
- `BmadInterface.tsx` - Main BMad interface component
- `useBmadSession` hook - Session state management
- `PathwaySelector` - Pathway selection for session creation
- `SessionManager` - Active session management interface

**Integration Flow:**
1. User selects pathway → `handlePathwaySelected()` → `createSession()`
2. Component loads → `checkForActiveSessions()` → `getUserSessions()`
3. Error states displayed in UI when database operations fail

### File Locations
**Database Layer:**
- `lib/bmad/database.ts` - Core database operations (CRITICAL - errors occurring here)
- `lib/bmad/session-orchestrator.ts` - Session management logic
- `lib/bmad/types.ts` - TypeScript interfaces and types

**API Layer:**
- `app/api/bmad/route.ts` - API endpoint handlers (CRITICAL - 500 errors here)

**UI Layer:**
- `apps/web/app/components/bmad/BmadInterface.tsx` - Main interface
- `apps/web/app/components/bmad/useBmadSession.ts` - Session hook

**Configuration:**
- `lib/supabase/server.ts` - Server-side Supabase client
- `lib/supabase/client.ts` - Client-side Supabase client

### Technical Constraints
[Source: docs/current/production-state/CURRENT-IMPLEMENTATION-STATUS.md]

**Technology Stack:**
- Next.js 15.5.0 with Turbopack
- TypeScript with strict mode enabled
- Supabase (@supabase/supabase-js v2.56.0)
- PostgreSQL database with comprehensive schema

**Performance Requirements:**
- Database queries should complete <500ms
- Session creation operations: Target <200ms p95 latency
- Session retrieval operations: Target <100ms p95 latency
- Session creation must handle 10+ concurrent users without degradation
- Maintain existing response time targets for other operations

**Compatibility Requirements:**
- Maintain existing API endpoint structure
- Preserve existing UI component interfaces  
- Database schema changes must be backward compatible

### Testing

**Testing Standards:**
[Source: Project configuration analysis]

**Test File Locations:**
- Unit tests: `apps/web/tests/` directory following existing pattern
- Integration tests: `apps/web/tests/api/` for API endpoint tests
- Component tests: `apps/web/tests/components/bmad/` for UI component tests
- Test files use `.test.ts` or `.test.tsx` extension

**Testing Framework:**
- **Vitest** - Confirmed in apps/web/package.json
- Test environment: jsdom (configured in vitest.config.ts)
- Testing utilities: @testing-library/react, @testing-library/jest-dom
- Run tests with: `npm run test` or `npm run test:run`

**Specific Testing Requirements:**
- Mock Supabase client for unit tests
- Test RLS policies don't block valid operations
- Test concurrent session creation scenarios
- Verify error messages are user-friendly and debuggable
- Ensure no regression in existing chat functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation for session creation database fixes | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
- **Task 1 Completed**: Fixed double `instanceof Error` bug in database.ts:181 causing malformed error messages
- **Task 2 Completed**: Enhanced API error handling with specific error codes and meaningful messages to replace "Unknown error"
- **Task 3 Completed**: Fixed getUserSessions method with proper authentication, RLS policy detection, and comprehensive error categorization
- **Task 4 Completed**: Enhanced all API endpoints with detailed logging, proper HTTP status codes, and parameter validation
- **Task 5 Completed**: Created comprehensive test suite covering unit tests for database operations and integration tests for all API endpoints
- **Improved Error Classification**: API handlers now categorize errors (AUTH_REQUIRED, INVALID_PATHWAY, DB_ERROR, RLS_POLICY_ERROR, etc.)  
- **Database Performance**: Verified optimal indexing for getUserSessions query operations
- **Build Verification**: All fixes pass TypeScript compilation and build process multiple times
- **Parameter Validation**: Added comprehensive validation for all API endpoint parameters

### File List
**Modified:**
- `lib/bmad/database.ts` - Fixed double error check bug in createSession method and enhanced getUserSessions with authentication verification, RLS policy detection, and comprehensive error categorization
- `app/api/bmad/route.ts` - Enhanced error handling with specific error codes, detailed logging, parameter validation, and improved HTTP status codes for all endpoints
- `app/page.tsx` - Fixed React unescaped quotes linting error

**Created:**
- `apps/web/tests/lib/bmad/database.test.ts` - Comprehensive unit tests for database operations (createSession, getUserSessions)  
- `apps/web/tests/api/bmad.test.ts` - Extensive integration tests for all API endpoints with various error scenarios and edge cases

## QA Results

*This section will be populated by QA Agent after story completion*
