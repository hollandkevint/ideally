# Story 1.7: Context Bridging Between Chat and Canvas

## Status

**Current Status:** Draft

## Story

**As a** strategic thinker developing complex ideas,  
**I want** seamless integration between my conversations with Mary and my visual work on the canvas,  
**so that** insights from dialogue automatically inform my visual thinking, and visual discoveries enhance our strategic conversations, creating a unified thinking environment where both modes of exploration reinforce each other.

## Acceptance Criteria

1. **AI-Driven Visual Element Suggestions from Conversation**
   - Mary analyzes chat context to suggest relevant visual elements for canvas
   - Real-time identification of concepts, processes, and relationships suitable for visualization
   - One-click insertion of suggested elements (Excalidraw shapes, Mermaid diagrams)
   - Context-aware positioning and styling of suggested visual elements
   - Visual suggestion history and refinement based on user acceptance patterns

2. **Canvas-to-Chat Context Integration**
   - Canvas annotations and elements become conversational reference points
   - Mary can directly reference visual elements in responses ("Looking at your SWOT matrix...")
   - Click-to-discuss functionality on canvas elements triggering focused chat conversations
   - Visual changes automatically update Mary's conversation context
   - Canvas element metadata enriches chat suggestions and follow-up questions

3. **Unified Cross-Modal Search and Discovery**
   - Single search interface across chat history, canvas annotations, and Mermaid diagrams
   - Semantic search connecting related concepts between conversation and visuals
   - Timeline view showing evolution of ideas across both chat and canvas
   - Tag system linking related insights between conversational and visual elements
   - Smart recommendations surfacing relevant past work across both modalities

4. **Dynamic Context Bridging and Suggestion Engine**
   - Real-time analysis of conversation flow to suggest visual representations
   - Canvas activity triggers contextual conversation starters and strategic questions
   - Automatic insight extraction and cross-referencing between dialogue and visuals
   - Progressive context building as ideas develop across both modes
   - Conflict detection when visual and conversational insights diverge

5. **Integrated Strategic Workflow Orchestration**
   - Guided workflows that seamlessly move between conversation and visualization
   - Strategic framework integration (Mary suggests→user sketches→Mary analyzes)
   - Session planning that alternates between dialogue exploration and visual synthesis
   - Export functionality capturing both conversational insights and visual artifacts
   - Collaboration features maintaining context bridging for team strategic sessions

## Tasks / Subtasks

- [ ] **AI-Driven Visual Suggestion Engine** (AC: 1)
  - [ ] Create conversation analysis service for visual element identification
  - [ ] Build real-time concept extraction from chat messages using Claude API
  - [ ] Implement visual element suggestion UI with preview thumbnails
  - [ ] Create one-click insertion system for Excalidraw and Mermaid elements
  - [ ] Add context-aware positioning algorithm for suggested visual elements
  - [ ] Build suggestion refinement system based on user acceptance patterns
  - [ ] Create visual suggestion history and recommendation improvement

- [ ] **Canvas-to-Chat Reference System** (AC: 2)
  - [ ] Design canvas element annotation and metadata system
  - [ ] Implement click-to-discuss functionality on canvas elements
  - [ ] Create Mary's visual element reference capabilities in conversation
  - [ ] Build canvas change detection and context update system
  - [ ] Add visual element metadata enrichment for chat suggestions
  - [ ] Create focused conversation triggers based on canvas interactions
  - [ ] Implement canvas element naming and description system

- [ ] **Cross-Modal Search and Discovery Platform** (AC: 3)
  - [ ] Build unified search index across chat, canvas, and Mermaid content
  - [ ] Implement semantic search using embedding-based similarity
  - [ ] Create timeline view showing idea evolution across both modes
  - [ ] Add tag system with automatic tag suggestion from content analysis
  - [ ] Build smart recommendation engine surfacing relevant past work
  - [ ] Create search result UI showing mixed chat/visual content
  - [ ] Add search filters for content type, time range, and strategic topics

- [ ] **Dynamic Context Bridging Intelligence** (AC: 4)
  - [ ] Create real-time conversation flow analysis for visual suggestions
  - [ ] Build canvas activity monitoring for contextual conversation triggers
  - [ ] Implement automatic insight extraction and cross-referencing system
  - [ ] Add progressive context building as ideas develop across modes
  - [ ] Create conflict detection between visual and conversational insights
  - [ ] Build context bridge analytics and optimization system
  - [ ] Add intelligent timing for cross-modal suggestions

- [ ] **Strategic Workflow Orchestration** (AC: 5)
  - [ ] Design guided workflow templates alternating chat and visual work
  - [ ] Create strategic framework integration (suggest→sketch→analyze cycle)
  - [ ] Build session planning with dual-mode milestone tracking
  - [ ] Implement unified export capturing both conversational and visual insights
  - [ ] Add collaboration features maintaining context bridging for teams
  - [ ] Create workflow analytics showing dual-mode engagement patterns
  - [ ] Build customizable workflow templates for different strategic thinking styles

## Dev Notes

Based on the architecture document and Epic 1 foundation requirements, here are the complete implementation details for Story 1.7:

### Technical Stack Configuration

**Context Bridging Architecture:** Intelligent cross-modal integration
- Real-time event system connecting chat and canvas state changes
- Semantic analysis pipeline using Claude API for concept extraction
- Vector embeddings for cross-modal content similarity and search
- WebSocket connections for real-time context synchronization

**Core Context Bridging Types:**
```typescript
// Unified context bridging system
interface ContextBridge {
  id: string;
  source_type: 'chat_message' | 'canvas_element' | 'mermaid_diagram';
  source_id: string;
  target_type: 'chat_message' | 'canvas_element' | 'mermaid_diagram';
  target_id: string;
  bridge_type: 'reference' | 'suggestion' | 'evolution' | 'conflict';
  confidence_score: number;
  metadata: {
    semantic_similarity: number;
    temporal_proximity: number;
    user_validation: boolean;
    created_at: Date;
  };
}

// Cross-modal search and discovery
interface UnifiedSearchResult {
  id: string;
  content_type: 'chat' | 'canvas' | 'mermaid';
  content: string;
  excerpt: string;
  relevance_score: number;
  semantic_tags: string[];
  related_elements: ContextBridge[];
  timestamp: Date;
}

// Strategic workflow orchestration
interface WorkflowSession {
  id: string;
  template_type: 'swot_analysis' | 'decision_tree' | 'process_mapping';
  current_phase: 'exploration' | 'visualization' | 'synthesis';
  chat_milestones: ChatMilestone[];
  visual_milestones: VisualMilestone[];
  context_bridges: ContextBridge[];
  completion_progress: number;
}
```

**Real-Time Context Bridging Engine:**
```typescript
// Intelligent context bridging service
class ContextBridgingEngine {
  private eventBus: EventEmitter;
  private semanticAnalyzer: SemanticAnalyzer;
  private suggestionEngine: SuggestionEngine;

  constructor() {
    this.eventBus = new EventEmitter();
    this.setupEventListeners();
  }

  private setupEventListeners() {
    // Chat events trigger visual suggestions
    this.eventBus.on('chat:message_sent', async (message: ChatMessage) => {
      const visualSuggestions = await this.analyzeForVisualOpportunities(message);
      this.eventBus.emit('suggestions:visual_elements', visualSuggestions);
    });

    // Canvas events trigger conversation updates
    this.eventBus.on('canvas:element_created', async (element: CanvasElement) => {
      const conversationContext = await this.analyzeForConversationTriggers(element);
      this.eventBus.emit('suggestions:conversation_topics', conversationContext);
    });

    // Cross-modal search queries
    this.eventBus.on('search:unified_query', async (query: string) => {
      const results = await this.performSemanticSearch(query);
      this.eventBus.emit('search:results', results);
    });
  }

  async analyzeForVisualOpportunities(message: ChatMessage): Promise<VisualSuggestion[]> {
    const prompt = `
    Analyze this conversation message and identify opportunities for visual representation:
    
    "${message.content}"
    
    Context: Previous conversation history shows discussion of ${this.getConversationContext()}
    
    Suggest specific visual elements that would enhance understanding:
    - Excalidraw shapes for concepts, relationships, processes
    - Mermaid diagrams for structured workflows, decisions, timelines
    - Positioning suggestions relative to existing canvas elements
    
    Focus on actionable visual suggestions that add strategic value.
    `;

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 1500
    });

    return this.parseVisualSuggestions(response.content);
  }

  async analyzeForConversationTriggers(element: CanvasElement): Promise<ConversationTrigger[]> {
    const elementContext = this.extractElementContext(element);
    
    const prompt = `
    A user just created/modified this visual element: ${elementContext}
    
    Current conversation context: ${this.getConversationContext()}
    
    Suggest strategic conversation starters that Mary should offer:
    - Questions that probe deeper into the visual concept
    - Strategic challenges to test assumptions
    - Opportunities to explore related frameworks
    - Connections to previous conversation topics
    
    Focus on high-value strategic coaching questions.
    `;

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 1000
    });

    return this.parseConversationTriggers(response.content);
  }
}
```

**Semantic Search and Discovery System:**
```typescript
// Vector-based semantic search across all content types
class UnifiedSearchEngine {
  private vectorStore: VectorStore;
  private searchIndex: SearchIndex;

  async indexContent(content: UnifiedContent): Promise<void> {
    // Generate embeddings for semantic search
    const embedding = await this.generateEmbedding(content.text);
    
    // Store with rich metadata for filtering
    await this.vectorStore.store({
      id: content.id,
      embedding,
      metadata: {
        content_type: content.type,
        timestamp: content.created_at,
        semantic_tags: content.tags,
        related_elements: content.context_bridges
      }
    });

    // Update full-text search index
    await this.searchIndex.add(content);
  }

  async search(query: string, filters?: SearchFilters): Promise<UnifiedSearchResult[]> {
    // Combine semantic and keyword search
    const semanticResults = await this.vectorStore.similarity_search(
      await this.generateEmbedding(query),
      { limit: 20, filters }
    );

    const keywordResults = await this.searchIndex.search(query, filters);

    // Merge and rank results using hybrid scoring
    return this.mergeSearchResults(semanticResults, keywordResults);
  }

  async findRelatedContent(contentId: string): Promise<UnifiedSearchResult[]> {
    const content = await this.getContent(contentId);
    const embedding = await this.generateEmbedding(content.text);
    
    return await this.vectorStore.similarity_search(embedding, {
      limit: 10,
      exclude: [contentId]
    });
  }
}
```

**Strategic Workflow Orchestration:**
```typescript
// Guided workflows alternating between chat and visual work
class WorkflowOrchestrator {
  private workflows: Map<string, WorkflowTemplate> = new Map();
  private activeSessions: Map<string, WorkflowSession> = new Map();

  constructor() {
    this.initializeWorkflowTemplates();
  }

  private initializeWorkflowTemplates() {
    // SWOT Analysis workflow
    this.workflows.set('swot_analysis', {
      name: 'Strategic SWOT Analysis',
      phases: [
        {
          phase: 'exploration',
          mode: 'chat',
          prompt: 'Let\'s explore your organization\'s strategic position...',
          completion_criteria: ['strengths_identified', 'weaknesses_discussed']
        },
        {
          phase: 'visualization',
          mode: 'canvas',
          suggestion: 'Create a SWOT matrix to organize these insights visually',
          completion_criteria: ['swot_matrix_created', 'elements_positioned']
        },
        {
          phase: 'synthesis',
          mode: 'chat',
          prompt: 'Looking at your SWOT matrix, what strategic opportunities emerge?',
          completion_criteria: ['strategies_identified', 'priorities_set']
        }
      ]
    });

    // Decision Analysis workflow
    this.workflows.set('decision_analysis', {
      name: 'Strategic Decision Analysis',
      phases: [
        {
          phase: 'exploration',
          mode: 'chat',
          prompt: 'Tell me about the decision you\'re facing and the options you\'re considering...',
          completion_criteria: ['decision_defined', 'options_identified']
        },
        {
          phase: 'visualization',
          mode: 'mermaid',
          suggestion: 'Let\'s create a decision tree to map out the logic and outcomes',
          completion_criteria: ['decision_tree_created', 'outcomes_mapped']
        },
        {
          phase: 'synthesis',
          mode: 'chat',
          prompt: 'Analyzing your decision tree, which path offers the best strategic value?',
          completion_criteria: ['recommendation_made', 'next_steps_defined']
        }
      ]
    });
  }

  async startWorkflow(workflowType: string, userId: string): Promise<WorkflowSession> {
    const template = this.workflows.get(workflowType);
    if (!template) throw new Error(`Workflow ${workflowType} not found`);

    const session: WorkflowSession = {
      id: generateId(),
      template_type: workflowType,
      current_phase: template.phases[0].phase,
      chat_milestones: [],
      visual_milestones: [],
      context_bridges: [],
      completion_progress: 0
    };

    this.activeSessions.set(session.id, session);
    return session;
  }

  async progressWorkflow(sessionId: string, milestone: Milestone): Promise<WorkflowPhase | null> {
    const session = this.activeSessions.get(sessionId);
    if (!session) return null;

    const template = this.workflows.get(session.template_type);
    const currentPhase = template.phases.find(p => p.phase === session.current_phase);

    // Check if phase completion criteria met
    if (this.isPhaseComplete(currentPhase, session)) {
      const nextPhaseIndex = template.phases.findIndex(p => p.phase === session.current_phase) + 1;
      
      if (nextPhaseIndex < template.phases.length) {
        session.current_phase = template.phases[nextPhaseIndex].phase;
        return template.phases[nextPhaseIndex];
      } else {
        // Workflow complete
        return null;
      }
    }

    return currentPhase;
  }
}
```

**Database Schema Extensions:**
```sql
-- Context bridging system
CREATE TABLE context_bridges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    source_type TEXT NOT NULL,
    source_id UUID NOT NULL,
    target_type TEXT NOT NULL,
    target_id UUID NOT NULL,
    bridge_type TEXT NOT NULL,
    confidence_score DECIMAL(3,2),
    user_validated BOOLEAN DEFAULT FALSE,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Unified content search index
CREATE TABLE content_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content_id UUID NOT NULL,
    content_type TEXT NOT NULL,
    embedding VECTOR(1536), -- OpenAI embedding dimension
    content_text TEXT NOT NULL,
    semantic_tags TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Strategic workflow sessions
CREATE TABLE workflow_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    workflow_type TEXT NOT NULL,
    current_phase TEXT NOT NULL,
    completion_progress DECIMAL(5,2) DEFAULT 0,
    session_state JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_context_bridges_source ON context_bridges(source_type, source_id);
CREATE INDEX idx_context_bridges_target ON context_bridges(target_type, target_id);
CREATE INDEX idx_content_embeddings_vector ON content_embeddings USING ivfflat (embedding vector_cosine_ops);
```

**Key Architecture Decisions:**
- Real-time event system enables immediate context bridging without polling
- Vector embeddings provide semantic search across all content types
- Workflow orchestration guides users through strategic thinking processes
- Context bridges create explicit relationships between conversational and visual insights
- AI-driven suggestions leverage full conversation and canvas context for intelligent recommendations

**Environment Variables:**
```bash
# Context Bridging
NEXT_PUBLIC_ENABLE_CONTEXT_BRIDGING=true
NEXT_PUBLIC_SEMANTIC_SEARCH_THRESHOLD=0.7
NEXT_PUBLIC_MAX_CONTEXT_BRIDGES=1000
OPENAI_API_KEY=your_openai_key # For embeddings

# Workflow Orchestration
NEXT_PUBLIC_ENABLE_GUIDED_WORKFLOWS=true
NEXT_PUBLIC_DEFAULT_WORKFLOW_TIMEOUT=3600 # 1 hour
```

### Testing

**Testing Standards:**

**Test File Location:** 
- Context bridging tests: `apps/web/tests/context-bridging/`
- Semantic search tests: `apps/web/tests/unified-search/`
- Workflow orchestration tests: `apps/web/tests/strategic-workflows/`

**Testing Frameworks:**
- **Frontend:** Vitest + Testing Library for bridging UI components
- **E2E:** Playwright for cross-modal workflow testing
- **AI Integration:** Mock Claude and OpenAI responses for consistent testing

**Specific Testing Requirements:**
- Test real-time context bridging between chat messages and canvas elements
- Verify semantic search accuracy across mixed content types
- Test workflow orchestration with phase transitions and completion tracking
- Validate AI suggestion quality and relevance scoring
- Test collaborative context bridging with multiple users
- Verify performance with large volumes of cross-referenced content

**Performance Requirements:**
- Context bridge creation under 200ms for real-time suggestions
- Semantic search results under 500ms for complex queries
- Visual suggestion generation under 1 second from chat analysis
- Workflow phase transitions under 100ms for smooth user experience

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-24 | 1.0 | Initial story creation for Epic 1.7 Context Bridging Between Chat and Canvas | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used

*(To be populated by development agent during implementation)*

### Debug Log References

*(To be populated by development agent during implementation)*

### Completion Notes List

*(To be populated by development agent during implementation)*

### File List

*(To be populated by development agent during implementation)*

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*