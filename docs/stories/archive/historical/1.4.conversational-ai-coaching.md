# Story 1.4: Conversational AI Coaching Interface

## Status

**Current Status:** Draft

## Story

**As a** strategic thinker and business professional,
**I want** to engage with Mary, an intelligent AI business analyst, through rich conversational interfaces,
**so that** I can receive expert strategic guidance, explore complex business challenges through dialogue, and benefit from AI-powered coaching that adapts to my specific needs and industry context.

## Acceptance Criteria

1. **Claude Sonnet 4 API Integration with Intelligent Rate Management**
   - Implement API client with automatic retry logic and exponential backoff
   - Token usage tracking per session with cost estimation display
   - Streaming response support for real-time conversation flow
   - Context window management (200k tokens) with intelligent truncation
   - Error handling for API failures with graceful degradation

2. **Mary AI Persona with Strategic Coaching Expertise**
   - System prompt configuration defining Mary's role, expertise, and communication style
   - Consistent personality traits: professional yet approachable, insightful, action-oriented
   - Domain knowledge in business strategy, problem-solving frameworks, and executive coaching
   - Adaptive coaching style based on user's industry and experience level
   - Memory of conversation context to build on previous insights

3. **Rich Message Interface with Strategic Thinking Support**
   - Markdown rendering for formatted strategic insights and structured thinking
   - Code syntax highlighting for technical strategy discussions
   - Interactive elements: collapsible sections for deep dives, action item checkboxes
   - Message threading for exploring multiple strategic paths
   - Copy/export functionality for preserving valuable insights

4. **Guided Conversation Flows for Strategic Exploration**
   - Conversation starters library with strategic thinking prompts
   - Smart follow-up suggestions based on conversation context
   - Framework templates (SWOT, Porter's Five Forces, Blue Ocean, etc.)
   - Progress indicators showing exploration depth and coverage
   - Conversation branching for exploring alternative scenarios

5. **Strategic Context Preservation and Evolution**
   - Auto-save conversation history with versioning
   - Conversation summarization for quick context recovery
   - Tag system for organizing insights by topic/project
   - Search functionality across conversation history
   - Export options for sharing strategic insights

## Tasks / Subtasks

- [ ] **Claude Sonnet 4 API Integration Foundation** (AC: 1)
  - [ ] Install OpenAI SDK and create Claude API client wrapper
  - [ ] Implement streaming response handler with message chunking
  - [ ] Create token counting service with usage tracking database table
  - [ ] Build retry logic with exponential backoff (3 attempts, 2^n delay)
  - [ ] Add context window monitoring with intelligent message truncation
  - [ ] Configure environment variables and API key management
  - [ ] Create comprehensive error handling with user-friendly messages

- [ ] **Mary AI Persona Configuration System** (AC: 2)
  - [ ] Design persona configuration schema with role, expertise, and style settings
  - [ ] Create Mary's base system prompt with strategic coaching personality
  - [ ] Implement adaptive prompt modification based on user profile/industry
  - [ ] Build conversation context memory system (last 20 exchanges)
  - [ ] Create persona consistency validation and testing framework
  - [ ] Add domain knowledge injection for business strategy frameworks

- [ ] **Rich Chat Interface Components** (AC: 3)
  - [ ] Build message component with Markdown rendering (react-markdown)
  - [ ] Add syntax highlighting for code blocks (Prism.js integration)
  - [ ] Create collapsible sections component for strategic deep dives
  - [ ] Implement interactive checkboxes for action items
  - [ ] Build message threading UI for exploring alternative paths
  - [ ] Add copy/export functionality with formatted output options
  - [ ] Create message loading states and error displays

- [ ] **Strategic Conversation Flow Engine** (AC: 4)
  - [ ] Create conversation starters database with strategic thinking prompts
  - [ ] Build smart follow-up suggestion engine using conversation analysis
  - [ ] Implement strategic framework templates (SWOT, Five Forces, etc.)
  - [ ] Create progress tracking system showing exploration coverage
  - [ ] Build conversation branching interface for scenario exploration
  - [ ] Add conversation flow analytics and optimization

- [ ] **Context Preservation & History Management** (AC: 5)
  - [ ] Design conversation storage schema with versioning support
  - [ ] Implement auto-save functionality with debounced updates
  - [ ] Create conversation summarization using Claude API
  - [ ] Build tag system with autocomplete and category management
  - [ ] Implement full-text search across conversation history
  - [ ] Add export functionality (PDF, Markdown, structured JSON)
  - [ ] Create conversation archival and cleanup processes

## Dev Notes

Based on the architecture document and Epic 1 foundation requirements, here are the complete implementation details for Story 1.4:

### Technical Stack Configuration

**AI Integration:** Claude Sonnet 4 via Anthropic API
- Direct integration with @anthropic-ai/sdk ^0.17.0
- Streaming responses with Server-Sent Events for real-time chat
- Context window: 200,000 tokens with intelligent conversation pruning
- Rate limiting: 4,000 RPM with queue management and user feedback

**Chat Interface Architecture:**
```typescript
// Core chat types for Mary persona integration
interface ChatMessage {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata: {
    tokens_used: number;
    conversation_branch?: string;
    strategic_tags: string[];
  };
}

interface MaryPersona {
  base_prompt: string;
  expertise_domains: string[];
  communication_style: 'professional' | 'casual' | 'executive';
  adaptive_context: UserProfile;
}

// Strategic conversation state management
interface ConversationState {
  session_id: string;
  mary_context: MaryPersona;
  messages: ChatMessage[];
  frameworks_discussed: string[];
  strategic_insights: InsightNode[];
  canvas_references: CanvasElementRef[];
}
```

**Mary AI Persona Implementation:**
```typescript
// Mary's strategic coaching system prompt
const MARY_BASE_PROMPT = `
You are Mary, a seasoned AI Business Analyst with 15+ years of strategic consulting experience.

PERSONALITY TRAITS:
- Professional yet approachable, insightful without being overwhelming
- Action-oriented with a bias toward practical implementation
- Expert in business strategy, problem-solving frameworks, and executive coaching
- Adapts communication style to user's experience level and industry context

STRATEGIC EXPERTISE:
- Business strategy frameworks (Porter's Five Forces, Blue Ocean, etc.)
- Problem-solving methodologies (5 Whys, Root Cause Analysis)
- Strategic planning and execution frameworks
- Competitive analysis and market positioning

CONVERSATION STYLE:
- Ask probing questions that reveal underlying assumptions
- Offer multiple perspectives on strategic challenges
- Provide actionable recommendations with clear next steps
- Reference established frameworks when relevant but don't over-complicate
`;
```

**Real-Time Communication Architecture:**
```typescript
// Streaming response handling for conversational flow
const StreamingChatHandler = {
  async sendMessage(message: string, conversationId: string) {
    const stream = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 4096,
      temperature: 0.7,
      system: buildMaryPrompt(conversationContext),
      messages: formatConversationHistory(messages),
      stream: true
    });

    // Real-time UI updates as tokens arrive
    for await (const chunk of stream) {
      if (chunk.type === 'content_block_delta') {
        updateChatInterface(chunk.delta.text);
      }
    }
  }
};
```

**Strategic Framework Integration:**
```typescript
// Built-in strategic thinking templates
const STRATEGIC_FRAMEWORKS = {
  'swot-analysis': {
    prompt_template: 'Let\'s conduct a SWOT analysis...',
    guided_questions: [
      'What are your organization\'s core strengths?',
      'What weaknesses need addressing?',
      'What opportunities do you see in the market?',
      'What threats concern you most?'
    ],
    canvas_visualization: 'swot-matrix'
  },
  'five-forces': {
    prompt_template: 'Let\'s analyze your competitive landscape...',
    guided_questions: [/* Porter's Five Forces questions */],
    canvas_visualization: 'five-forces-diagram'
  }
};
```

**Database Schema Extensions:**
```sql
-- Chat conversation storage with Mary persona context
CREATE TABLE chat_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    mary_persona_config JSONB NOT NULL,
    conversation_metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES chat_conversations(id),
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    tokens_used INTEGER,
    strategic_tags TEXT[],
    canvas_references UUID[],
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE strategic_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES chat_conversations(id),
    insight_type TEXT NOT NULL,
    content TEXT NOT NULL,
    framework_used TEXT,
    canvas_element_id UUID,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Key Architecture Decisions:**
- Mary persona configuration stored per conversation for consistency
- Strategic framework templates integrated with canvas visualization hints
- Message threading supported through conversation branching
- Token usage tracking for cost management and user transparency
- Canvas reference integration prepared for Story 1.7 (Context Bridging)

**Environment Variables Required:**
```bash
# AI Integration
ANTHROPIC_API_KEY=your_anthropic_api_key
NEXT_PUBLIC_MAX_CONVERSATION_LENGTH=50

# Chat Features
NEXT_PUBLIC_ENABLE_MESSAGE_EXPORT=true
NEXT_PUBLIC_STRATEGIC_FRAMEWORKS_ENABLED=true
```

### Testing

**Testing Standards from Architecture:**

**Test File Location:** 
- Chat interface tests: `apps/web/tests/chat/`
- Mary persona tests: `apps/web/tests/ai-persona/`
- Strategic framework tests: `apps/web/tests/frameworks/`

**Testing Frameworks:**
- **Frontend:** Vitest + Testing Library for chat components
- **E2E:** Playwright for conversational flow testing
- **AI Integration:** Mock Anthropic API responses for consistent testing

**Specific Testing Requirements:**
- Test Mary persona consistency across conversation sessions
- Verify streaming response handling and error recovery
- Test strategic framework template integration
- Validate token usage tracking accuracy
- Test conversation export functionality with various formats
- Verify mobile chat interface usability

**AI Testing Patterns:**
- Mock Anthropic API responses for predictable test scenarios
- Test conversation context preservation across page refreshes
- Validate Mary's adaptive communication style based on user profiles
- Test strategic framework guidance and canvas integration hints

**Performance Requirements:**
- Initial chat interface load under 2 seconds
- Streaming message display latency under 100ms per chunk
- Conversation history search under 500ms for 1000+ messages
- Strategic framework template loading under 1 second

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-24 | 1.0 | Initial story creation for Epic 1.4 Conversational AI Coaching Interface | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used

*(To be populated by development agent during implementation)*

### Debug Log References

*(To be populated by development agent during implementation)*

### Completion Notes List

*(To be populated by development agent during implementation)*

### File List

*(To be populated by development agent during implementation)*

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*