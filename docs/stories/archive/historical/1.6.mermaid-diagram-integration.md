# Story 1.6: Mermaid Diagram Integration

## Status

**Current Status:** Draft

## Story

**As a** process-oriented thinker and strategic professional,  
**I want** to create structured flowcharts, decision trees, and process diagrams using Mermaid syntax,  
**so that** I can visualize complex workflows, decision logic, and system relationships with precision while maintaining the casual, iterative nature of strategic exploration.

## Acceptance Criteria

1. **Mermaid.js Integration with Live Preview System**
   - Embedded Mermaid editor with real-time diagram rendering
   - Split-pane view: Mermaid syntax (left), live diagram preview (right)
   - Auto-refresh on syntax changes with debounced updates
   - Error highlighting and validation feedback in editor
   - Support for Mermaid themes matching workspace aesthetic

2. **Strategic Diagram Types with Business Focus**
   - Flowcharts for process mapping and decision workflows
   - Sequence diagrams for stakeholder interaction analysis
   - Gantt charts for project timeline visualization
   - Entity relationship diagrams for organizational structure
   - Decision trees for strategic option analysis
   - Sankey diagrams for resource flow visualization

3. **AI-Assisted Diagram Generation from Text**
   - Claude integration to convert text descriptions into Mermaid syntax
   - Smart template suggestions based on content analysis
   - Process flow generation from written procedures
   - Decision tree creation from conditional logic descriptions
   - Organization chart generation from team/role descriptions

4. **Professional Export and Collaboration**
   - High-quality PNG/SVG export with customizable styling
   - Shareable Mermaid code with version control
   - Integration with common business tools (presentations, docs)
   - Collaborative editing with conflict resolution
   - Template library for common business diagram patterns

5. **Workspace Integration and Context Preservation**
   - Auto-save Mermaid diagrams within workspace state
   - Cross-referencing with chat conversations and canvas sketches
   - Diagram versioning with change history tracking
   - Search functionality across diagram content and comments
   - Integration with Mary's coaching context for diagram discussions

## Tasks / Subtasks

- [ ] **Mermaid.js Integration Foundation** (AC: 1)
  - [ ] Install mermaid library and React wrapper components
  - [ ] Create split-pane Mermaid editor with Monaco editor integration
  - [ ] Implement real-time diagram rendering with debounced updates (300ms)
  - [ ] Add Mermaid syntax validation and error highlighting
  - [ ] Configure custom themes matching workspace design system
  - [ ] Create diagram loading states and error boundary handling
  - [ ] Test performance with complex diagrams (100+ nodes)

- [ ] **Strategic Diagram Type Support** (AC: 2)
  - [ ] Implement flowchart support with business process templates
  - [ ] Add sequence diagram capability for stakeholder analysis
  - [ ] Create Gantt chart integration for project timeline visualization
  - [ ] Build entity relationship diagram support for org structures
  - [ ] Add decision tree templates for strategic option analysis
  - [ ] Implement Sankey diagram support for resource flow mapping
  - [ ] Create diagram type selector with preview thumbnails

- [ ] **AI-Assisted Diagram Generation Engine** (AC: 3)
  - [ ] Design Claude prompt templates for text-to-Mermaid conversion
  - [ ] Create content analysis engine for diagram type suggestions
  - [ ] Build process flow generator from procedural text descriptions
  - [ ] Implement decision tree creator from conditional logic text
  - [ ] Add organization chart generator from team/role mentions
  - [ ] Create template suggestion system based on content analysis
  - [ ] Build one-click diagram generation from AI suggestions

- [ ] **Professional Export and Sharing** (AC: 4)
  - [ ] Implement high-resolution PNG/SVG export with custom styling
  - [ ] Create shareable Mermaid code URLs with version tracking
  - [ ] Build integration APIs for PowerPoint/Google Slides embedding
  - [ ] Add collaborative editing with real-time conflict resolution
  - [ ] Create business diagram template library with categories
  - [ ] Implement diagram embedding codes for external documents
  - [ ] Add bulk export functionality for multiple diagrams

- [ ] **Workspace Integration and Context System** (AC: 5)
  - [ ] Design Mermaid diagram storage within workspace state schema
  - [ ] Implement auto-save functionality with workspace persistence
  - [ ] Create cross-referencing system linking diagrams to chat/canvas
  - [ ] Build diagram version history with visual diff capabilities
  - [ ] Add full-text search across diagram content and metadata
  - [ ] Integrate Mary's coaching context for diagram-based discussions
  - [ ] Create diagram activity feed showing changes and collaborations

## Dev Notes

Based on the architecture document and strategic diagram requirements, here are the complete implementation details for Story 1.6:

### Technical Stack Configuration

**Mermaid Integration:** Core library with React wrapper
- mermaid ^10.6.0 with React integration via @mermaid-js/mermaid
- Monaco Editor for syntax highlighting and auto-completion
- Split-pane layout with real-time preview synchronization
- Custom theme integration matching workspace design system

**Diagram Editor Architecture:**
```typescript
// Core Mermaid types for strategic business diagrams
interface MermaidDiagram {
  id: string;
  type: 'flowchart' | 'sequence' | 'gantt' | 'er' | 'gitgraph' | 'sankey';
  title: string;
  mermaid_code: string;
  rendered_svg: string;
  metadata: {
    created_at: Date;
    updated_at: Date;
    version: number;
    tags: string[];
    linked_elements: {
      chat_messages: string[];
      canvas_elements: string[];
    };
  };
}

// Strategic diagram workspace state
interface DiagramWorkspaceState {
  diagrams: MermaidDiagram[];
  active_diagram_id: string | null;
  diagram_templates: DiagramTemplate[];
  collaboration_state: CollaborationSession[];
  export_settings: ExportConfiguration;
}
```

**AI-Assisted Diagram Generation:**
```typescript
// Claude integration for text-to-Mermaid conversion
const generateMermaidFromText = async (text: string, diagramType?: string) => {
  const prompt = `
  Convert this text description into a Mermaid diagram:
  
  ${text}
  
  ${diagramType ? `Create a ${diagramType}` : 'Suggest the most appropriate diagram type and create it'}
  
  Rules:
  - Use clear, business-appropriate node labels
  - Include decision points and process flows
  - Follow Mermaid syntax best practices
  - Add styling for professional presentation
  
  Provide both the Mermaid code and a brief explanation of the diagram structure.
  `;
  
  return await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20241022',
    messages: [{ role: 'user', content: prompt }],
    max_tokens: 2000
  });
};

// Business diagram templates
const BUSINESS_DIAGRAM_TEMPLATES = {
  'strategic-planning': {
    type: 'flowchart',
    code: `flowchart TD
      A[Define Vision] --> B[Analyze Current State]
      B --> C[Identify Gaps]
      C --> D[Develop Strategy]
      D --> E[Create Action Plan]
      E --> F[Execute & Monitor]`,
    description: 'Strategic planning process flow'
  },
  'decision-tree': {
    type: 'flowchart',
    code: `flowchart TD
      A[Decision Point] --> B{Criterion 1?}
      B -->|Yes| C[Option A]
      B -->|No| D{Criterion 2?}
      D -->|Yes| E[Option B]
      D -->|No| F[Option C]`,
    description: 'Decision analysis framework'
  },
  'stakeholder-interaction': {
    type: 'sequence',
    code: `sequenceDiagram
      participant C as Customer
      participant S as Sales
      participant P as Product
      participant E as Engineering
      
      C->>S: Requirements
      S->>P: Analysis Request
      P->>E: Technical Feasibility
      E-->>P: Assessment
      P-->>S: Recommendation
      S-->>C: Proposal`,
    description: 'Stakeholder interaction flow'
  }
};
```

**Real-Time Editor Implementation:**
```typescript
// Mermaid editor component with live preview
import Monaco from '@monaco-editor/react';
import mermaid from 'mermaid';

const MermaidEditor = ({ diagram, onUpdate }: MermaidEditorProps) => {
  const [code, setCode] = useState(diagram.mermaid_code);
  const [renderedSvg, setRenderedSvg] = useState('');
  const [errors, setErrors] = useState<string[]>([]);

  // Debounced diagram rendering
  const debouncedRender = useCallback(
    debounce(async (mermaidCode: string) => {
      try {
        const { svg } = await mermaid.render('preview', mermaidCode);
        setRenderedSvg(svg);
        setErrors([]);
        
        // Auto-save to workspace
        onUpdate({
          ...diagram,
          mermaid_code: mermaidCode,
          rendered_svg: svg,
          metadata: {
            ...diagram.metadata,
            updated_at: new Date()
          }
        });
      } catch (error) {
        setErrors([error.message]);
      }
    }, 300),
    [diagram, onUpdate]
  );

  return (
    <div className="mermaid-editor grid grid-cols-2 gap-4 h-full">
      <div className="editor-pane">
        <Monaco
          language="mermaid"
          value={code}
          onChange={(value) => {
            setCode(value || '');
            debouncedRender(value || '');
          }}
          options={{
            minimap: { enabled: false },
            wordWrap: 'on',
            lineNumbers: 'on',
            theme: 'vs-light'
          }}
        />
        {errors.length > 0 && (
          <div className="error-panel">
            {errors.map((error, i) => (
              <div key={i} className="error-message">{error}</div>
            ))}
          </div>
        )}
      </div>
      
      <div className="preview-pane">
        <div 
          className="diagram-preview"
          dangerouslySetInnerHTML={{ __html: renderedSvg }}
        />
      </div>
    </div>
  );
};
```

**Export and Sharing System:**
```typescript
// Professional diagram export functionality
const DiagramExporter = {
  async exportPNG(diagram: MermaidDiagram, options: ExportOptions) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    return new Promise((resolve) => {
      img.onload = () => {
        canvas.width = img.width * (options.scale || 2);
        canvas.height = img.height * (options.scale || 2);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/png', options.quality || 0.95);
      };
      
      img.src = `data:image/svg+xml;base64,${btoa(diagram.rendered_svg)}`;
    });
  },

  exportSVG(diagram: MermaidDiagram, options: ExportOptions) {
    const styledSvg = addCustomStyling(diagram.rendered_svg, options.theme);
    return new Blob([styledSvg], { type: 'image/svg+xml' });
  },

  generateShareableCode(diagram: MermaidDiagram) {
    return {
      url: `${window.location.origin}/diagrams/${diagram.id}`,
      embed_code: `<iframe src="${window.location.origin}/diagrams/${diagram.id}/embed" width="800" height="600"></iframe>`,
      mermaid_code: diagram.mermaid_code
    };
  }
};
```

**Database Schema Extensions:**
```sql
-- Mermaid diagrams storage with version control
CREATE TABLE mermaid_diagrams (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES user_workspace(user_id),
    title TEXT NOT NULL,
    diagram_type TEXT NOT NULL,
    mermaid_code TEXT NOT NULL,
    rendered_svg TEXT,
    version INTEGER DEFAULT 1,
    tags TEXT[],
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Diagram version history for change tracking
CREATE TABLE diagram_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    diagram_id UUID REFERENCES mermaid_diagrams(id),
    version_number INTEGER NOT NULL,
    mermaid_code TEXT NOT NULL,
    changes_summary TEXT,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Cross-references between diagrams and other workspace elements
CREATE TABLE diagram_references (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    diagram_id UUID REFERENCES mermaid_diagrams(id),
    reference_type TEXT NOT NULL CHECK (reference_type IN ('chat_message', 'canvas_element', 'insight')),
    reference_id UUID NOT NULL,
    reference_context TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Key Architecture Decisions:**
- Monaco Editor provides professional code editing experience with syntax highlighting
- Real-time preview with debounced rendering prevents performance issues
- AI-assisted generation reduces Mermaid syntax learning curve
- Professional export capabilities suitable for business presentations
- Version control and collaboration support for team strategic planning
- Deep integration with chat and canvas for unified strategic thinking

**Environment Variables:**
```bash
# Mermaid Integration
NEXT_PUBLIC_MERMAID_THEME=business-theme
NEXT_PUBLIC_MAX_DIAGRAM_COMPLEXITY=500
NEXT_PUBLIC_ENABLE_DIAGRAM_COLLABORATION=true
NEXT_PUBLIC_DIAGRAM_EXPORT_QUALITY=0.95
```

### Testing

**Testing Standards:**

**Test File Location:** 
- Mermaid editor tests: `apps/web/tests/mermaid-editor/`
- Diagram generation tests: `apps/web/tests/ai-diagram-generation/`
- Export functionality tests: `apps/web/tests/diagram-export/`

**Testing Frameworks:**
- **Frontend:** Vitest + Testing Library for Mermaid components
- **E2E:** Playwright for diagram creation and export workflows
- **AI Integration:** Mock Claude responses for diagram generation testing

**Specific Testing Requirements:**
- Test real-time preview synchronization with Monaco editor
- Verify AI-assisted diagram generation from various text inputs
- Test professional PNG/SVG export with different styling options
- Validate diagram version control and collaboration features
- Test workspace integration and cross-referencing functionality
- Verify performance with complex diagrams (100+ nodes)

**Performance Requirements:**
- Diagram rendering under 500ms for standard business diagrams
- Real-time preview updates within 300ms of code changes
- Export generation under 3 seconds for high-resolution outputs
- Monaco editor loading under 1 second on initial load

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-24 | 1.0 | Initial story creation for Epic 1.6 Mermaid Diagram Integration | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used

*(To be populated by development agent during implementation)*

### Debug Log References

*(To be populated by development agent during implementation)*

### Completion Notes List

*(To be populated by development agent during implementation)*

### File List

*(To be populated by development agent during implementation)*

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*