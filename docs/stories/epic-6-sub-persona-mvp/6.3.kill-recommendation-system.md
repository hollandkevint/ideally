# Story 6.3: Kill Recommendation System

**Status:** Ready
**Priority:** P0 - Critical Path
**Estimate:** 6-8 hours
**Depends On:** Stories 6.1, 6.2

## User Story

As a ThinkHaven user, I want the AI to honestly recommend killing my idea when warranted, so that I don't waste months building something that won't work.

## Context

This is THE differentiator. Most AI tools are sycophantic - they tell users what they want to hear. ThinkHaven earns the right to kill an idea by doing the work first: exploring, challenging, and THEN rendering judgment.

**Key Principle:** Mary doesn't dismiss early. She explores, challenges, and then renders honest judgment.

## Acceptance Criteria

1. **Escalation sequence works**
   - Level 1: Diplomatic flags ("I see some significant risks here...")
   - Level 2: Deeper probe ("Let me challenge this assumption...")
   - Level 3: Explicit recommendation ("Based on what we've discussed, I don't think you should pursue this because...")
   - Level 4: Kill score with concrete viability rating

2. **Kill triggers identified**
   - No clear problem being solved
   - Target user undefined or too broad
   - Existing solutions adequate
   - Competitive moat absent
   - Revenue model unrealistic
   - Technical infeasibility

3. **Viability score generated**
   - Scale: 1-10
   - Transparent breakdown by dimension
   - Actionable: "If you addressed X, score could improve to Y"

4. **User gets chance to defend/pivot**
   - Each escalation level includes opportunity to respond
   - Valid pivots reset escalation
   - Double-down on weak position advances escalation

5. **Output includes kill recommendation when warranted**
   - Final Lean Canvas or PRD reflects honest assessment
   - Clear "Viability Score: X/10" in output
   - "Recommended Action: Pivot/Kill/Proceed" section

## Technical Implementation

### Files to Modify

1. **`lib/ai/mary-persona.ts`**
   - Add `KillAssessment` type (already defined, needs implementation)
   - Add `assessViability(conversationContext): ViabilityScore`
   - Add `generateKillRecommendation(score, issues): KillRecommendation`

2. **`lib/ai/claude-client.ts`**
   - Inject escalation context into system prompt
   - Track escalation level in conversation
   - Trigger viability assessment at session end

3. **`lib/bmad/generators/`**
   - Update Lean Canvas generator to include viability score
   - Update PRD generator to include "Recommended Action" section

### Viability Scoring

```typescript
interface ViabilityScore {
  overall: number; // 1-10
  dimensions: {
    problemClarity: number;      // Is the problem well-defined?
    targetUserClarity: number;   // Who is this for?
    solutionFit: number;         // Does solution address problem?
    competitiveMoat: number;     // Why won't others copy?
    revenueViability: number;    // Can this make money?
    technicalFeasibility: number; // Can this be built?
  };
  criticalIssues: string[];
  improvementOpportunities: string[];
}

function calculateViabilityScore(assessment: ViabilityAssessment): ViabilityScore {
  const dimensions = {
    problemClarity: assessProblemClarity(assessment),
    targetUserClarity: assessTargetUser(assessment),
    solutionFit: assessSolutionFit(assessment),
    competitiveMoat: assessMoat(assessment),
    revenueViability: assessRevenue(assessment),
    technicalFeasibility: assessTechnical(assessment)
  };

  const overall = Object.values(dimensions).reduce((a, b) => a + b, 0) / 6;

  return {
    overall: Math.round(overall * 10) / 10,
    dimensions,
    criticalIssues: identifyCriticalIssues(dimensions),
    improvementOpportunities: identifyImprovements(dimensions)
  };
}
```

### Escalation Prompts

```typescript
const escalationPrompts: Record<EscalationLevel, string> = {
  diplomatic: `
    Based on our discussion, I'm noticing some potential challenges:
    {issues}
    I want to explore these a bit more before we proceed. Can you help me understand...
  `,

  probing: `
    I need to challenge you directly on this:
    {issue}
    This is a critical assumption that could make or break your idea.
    How would you address this concern?
  `,

  explicit: `
    I've been thinking carefully about everything you've shared, and I need to be honest with you:
    {recommendation}
    Here's my reasoning:
    {rationale}
    You've done good work here, but I think pursuing this path would lead to:
    {consequences}
  `,

  kill_score: `
    ## Viability Assessment

    **Overall Score: {score}/10**

    | Dimension | Score | Notes |
    |-----------|-------|-------|
    {dimension_table}

    ### Critical Issues
    {critical_issues}

    ### Recommended Action: {action}
    {action_rationale}

    ### If You Want to Proceed Anyway
    Here's what you'd need to address:
    {improvements}
  `
};
```

### Kill Decision Matrix

```typescript
function recommendAction(score: ViabilityScore): RecommendedAction {
  if (score.overall >= 7) {
    return { action: 'proceed', confidence: 'high' };
  }
  if (score.overall >= 5) {
    return { action: 'pivot', confidence: 'medium' };
  }
  if (score.overall >= 3) {
    return { action: 'pivot', confidence: 'low' };
  }
  return { action: 'kill', confidence: 'high' };
}
```

## Testing

### Unit Tests
- [ ] Viability scoring calculation
- [ ] Critical issue identification
- [ ] Escalation level transitions
- [ ] Kill recommendation generation

### Integration Tests
- [ ] Full conversation with escalating concerns
- [ ] Viability score appears in output
- [ ] Pivot opportunity resets escalation

### Manual Testing
- [ ] Present obviously bad idea - verify kill recommendation
- [ ] Present marginal idea - verify pivot suggestion
- [ ] Present good idea - verify proceed with notes
- [ ] Verify user doesn't feel attacked (tone check)

## Dependencies

- Story 6.1 (Mode wiring)
- Story 6.2 (Dynamic shifting)
- Story 6.4 builds on this for output polish

## Out of Scope

- Historical kill rate analytics
- User feedback on kill accuracy
- Community validation features

## Notes

**Tone is critical.** The kill recommendation must feel like honest advice from a trusted advisor, not dismissal or criticism. The language should convey:

- "I've done the work to understand your idea"
- "I'm on your side"
- "I respect your time too much to let you waste it"
- "Here's how you could make this work if you really want to"

Never be mean. Be honest.
