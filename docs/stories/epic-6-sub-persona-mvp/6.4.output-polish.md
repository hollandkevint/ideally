# Story 6.4: Output Polish (Lean Canvas + PRD)

**Status:** Ready
**Priority:** P1 - High
**Estimate:** 4-6 hours
**Depends On:** Story 6.3

## User Story

As a ThinkHaven user, I want polished, portable outputs that I can share with stakeholders and use as working documents, so that my strategic session produces tangible value.

## Context

ThinkHaven's outputs should be:
- **High polish** for documents/specs (what you present to others)
- **Low polish** for wireframes/diagrams (thinking tools, not deliverables)

MVP focuses on the high-polish text outputs: Lean Canvas and PRD/Spec.

## Acceptance Criteria

1. **Lean Canvas output**
   - All 9 sections populated from conversation
   - Viability score included (from Story 6.3)
   - PDF-ready formatting
   - Markdown export option

2. **PRD/Spec output**
   - Executive summary
   - Problem statement
   - Target user definition
   - Proposed solution
   - Key features (prioritized)
   - Success metrics
   - Risks and mitigations
   - Viability assessment
   - Recommended next steps

3. **Output trigger timing**
   - Auto-suggest output generation after ~20 messages
   - User can request earlier via command
   - Session must have minimum content for meaningful output

4. **Export formats**
   - Markdown (default, clipboard-friendly)
   - PDF (professional, shareable)
   - JSON (for integrations, future)

5. **Quality validation**
   - Empty sections flagged with prompts
   - Low viability score prominent in output
   - "Draft" watermark if conversation incomplete

## Technical Implementation

### Files to Modify

1. **`lib/bmad/generators/LeanCanvasGenerator.ts`**
   - Add viability score section
   - Improve section extraction from conversation
   - Add confidence indicators per section

2. **`lib/bmad/generators/ProductBriefGenerator.ts`** (rename to PRDGenerator)
   - Add recommended action section
   - Include kill/pivot recommendation if applicable
   - Add next steps based on viability

3. **`app/components/bmad/OutputTypeSelector.tsx`**
   - Trigger at ~20 messages (already has hook)
   - Add visual polish to selector
   - Show preview before generation

4. **`lib/export/pdf-generator.ts`**
   - Update templates for new sections
   - Add viability score visualization
   - Improve typography

### Lean Canvas Template

```typescript
interface LeanCanvas {
  // Core sections
  problem: {
    content: string;
    existingAlternatives: string[];
    confidence: number;
  };
  customerSegments: {
    primary: string;
    earlyAdopters: string;
    confidence: number;
  };
  uniqueValueProposition: {
    headline: string;
    concept: string;
    confidence: number;
  };
  solution: {
    features: string[];
    confidence: number;
  };
  channels: {
    awareness: string[];
    acquisition: string[];
    confidence: number;
  };
  revenueStreams: {
    model: string;
    pricing: string;
    confidence: number;
  };
  costStructure: {
    fixed: string[];
    variable: string[];
    confidence: number;
  };
  keyMetrics: {
    metrics: string[];
    confidence: number;
  };
  unfairAdvantage: {
    content: string;
    confidence: number;
  };

  // ThinkHaven additions
  viabilityScore: ViabilityScore;
  recommendedAction: RecommendedAction;
  sessionMeta: {
    pathway: PathwayType;
    messageCount: number;
    generatedAt: Date;
  };
}
```

### PRD Template

```typescript
interface PRDOutput {
  meta: {
    title: string;
    version: string;
    lastUpdated: Date;
    status: 'draft' | 'reviewed' | 'approved';
  };

  executiveSummary: string;

  problem: {
    statement: string;
    evidence: string[];
    impact: string;
  };

  targetUser: {
    primary: string;
    jobToBeDone: string;
    painPoints: string[];
    currentSolutions: string[];
  };

  proposedSolution: {
    overview: string;
    keyFeatures: Feature[];
    differentiators: string[];
  };

  successMetrics: {
    primary: Metric[];
    secondary: Metric[];
  };

  risks: {
    technical: Risk[];
    market: Risk[];
    execution: Risk[];
  };

  viability: {
    score: ViabilityScore;
    recommendation: RecommendedAction;
    criticalPath: string[];
  };

  nextSteps: {
    immediate: string[];
    shortTerm: string[];
    ifProceeding: string[];
    ifPivoting: string[];
  };
}
```

### Extraction Logic

```typescript
async function extractLeanCanvasFromConversation(
  messages: Message[],
  assessment: ViabilityScore
): Promise<LeanCanvas> {
  // Use Claude to extract structured data from conversation
  const extractionPrompt = `
    Based on the following conversation, extract a Lean Canvas.
    For each section, also rate your confidence (0-1) based on how
    clearly this was discussed.

    If a section wasn't discussed, leave it empty but note that
    it needs more exploration.

    Conversation:
    ${formatMessages(messages)}
  `;

  const extraction = await claude.complete({
    prompt: extractionPrompt,
    schema: LeanCanvasSchema
  });

  return {
    ...extraction,
    viabilityScore: assessment,
    recommendedAction: recommendAction(assessment),
    sessionMeta: {
      pathway: getPathwayFromSession(),
      messageCount: messages.length,
      generatedAt: new Date()
    }
  };
}
```

## Testing

### Unit Tests
- [ ] Canvas section extraction
- [ ] PRD section population
- [ ] Confidence calculation
- [ ] Empty section detection

### Integration Tests
- [ ] Full conversation to Lean Canvas
- [ ] Full conversation to PRD
- [ ] PDF generation with all sections
- [ ] Markdown export quality

### Manual Testing
- [ ] Output readable and professional
- [ ] Viability score visible and clear
- [ ] Export works in all formats
- [ ] Can share with stakeholders (polish check)

## Dependencies

- Story 6.3 (Viability scoring)
- Existing export infrastructure

## Out of Scope

- Canvas/visual outputs (Post-MVP)
- HTML presentation export (Post-MVP)
- Notion/Coda integration (Future)

## Notes

The output is the tangible value users take away. It should feel like they had a session with a $5K consultant - but in 20 minutes instead of 2 weeks.

Key quality indicators:
- Would I send this to my boss?
- Does this look like something a consultant produced?
- Can someone not in the conversation understand the idea?
