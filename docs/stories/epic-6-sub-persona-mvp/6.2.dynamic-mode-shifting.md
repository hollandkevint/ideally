# Story 6.2: Dynamic Mode Shifting

**Status:** Ready
**Priority:** P0 - Critical Path
**Estimate:** 4-6 hours
**Depends On:** Story 6.1

## User Story

As a ThinkHaven user, I want the AI to detect my emotional state and adjust its mode accordingly, so that I receive appropriate support without feeling steamrolled or coddled.

## Context

Building on Story 6.1's mode wiring, this story adds intelligent mode shifting based on:
- User state detection (defensive, overconfident, spinning)
- Conversation flow analysis
- Strategic moment recognition

The sub-persona logic in `mary-persona.ts` already defines these triggers - this story implements them.

## Acceptance Criteria

1. **Detect user defensive state**
   - Signals: Short responses, pushback phrases ("but...", "that's not fair")
   - Response: Shift to Encouraging before returning to challenge
   - Prevents: User shutdown

2. **Detect user overconfidence**
   - Signals: Dismissive language, ignoring concerns, "I already thought of that"
   - Response: Lean into Devil's Advocate
   - Prevents: Premature commitment to flawed ideas

3. **Detect user spinning**
   - Signals: Circular logic, repeating same points, scope creep
   - Response: Shift to Realistic to ground
   - Prevents: Analysis paralysis

4. **Natural transitions**
   - Mode shifts feel conversational, not jarring
   - AI acknowledges the shift implicitly ("Let me step back and...")
   - Maximum 2 mode shifts per exchange

5. **User override after ~10 messages**
   - Surface explicit options: "Would you like me to be more challenging or supportive?"
   - User can guide mode preference
   - Stored in session context

## Technical Implementation

### Files to Modify

1. **`lib/ai/mary-persona.ts`**
   - Add `detectUserState(messages: Message[]): UserState`
   - Add `shouldShiftMode(currentMode, userState, messageCount): ShiftDecision`
   - Export transition phrases per mode shift

2. **`lib/ai/claude-client.ts`**
   - Call state detection before each response
   - Include shift context in system prompt if shifting
   - Track mode history in conversation

3. **`lib/ai/context-manager.ts`**
   - Store `currentMode` and `modeHistory` in session
   - Track `messageCount` for override trigger

### State Detection Logic

```typescript
interface UserState {
  type: 'neutral' | 'defensive' | 'overconfident' | 'spinning';
  confidence: number; // 0-1
  signals: string[];
}

const defensivePatterns = [
  /but\s+(that|you|it)/i,
  /that's not (fair|true|right)/i,
  /you don't understand/i,
  /it's more complicated/i
];

const overconfidentPatterns = [
  /i already (know|thought|considered)/i,
  /that's obvious/i,
  /trust me/i,
  /i've got this/i
];

const spinningPatterns = [
  // Repeated message similarity (embedding comparison)
  // Scope expansion keywords
  /also|and another thing|plus|additionally/i,
  // Circular references
];

function detectUserState(messages: Message[]): UserState {
  const recentUserMessages = messages
    .filter(m => m.role === 'user')
    .slice(-3);

  // Pattern matching with confidence scoring
  // ...
}
```

### Mode Shift Decision

```typescript
interface ShiftDecision {
  shouldShift: boolean;
  fromMode: SubPersonaMode;
  toMode: SubPersonaMode;
  reason: string;
  transitionPhrase: string;
}

const shiftMap: Record<UserState['type'], SubPersonaMode> = {
  defensive: 'encouraging',
  overconfident: 'devils_advocate',
  spinning: 'realistic',
  neutral: 'current' // No shift
};

const transitionPhrases: Record<string, string[]> = {
  'any_to_encouraging': [
    "I hear you. Let me acknowledge what's working here...",
    "You raise a fair point. Let's build on that...",
    "I appreciate you pushing back - that's actually a strength..."
  ],
  'any_to_devils_advocate': [
    "I want to pressure-test this a bit...",
    "Let me play devil's advocate for a moment...",
    "Before we move on, I need to challenge one thing..."
  ],
  'any_to_realistic': [
    "Let me ground us for a second...",
    "I want to make sure we're being practical here...",
    "Let's step back and look at constraints..."
  ]
};
```

## Testing

### Unit Tests
- [ ] Defensive state detection accuracy
- [ ] Overconfident state detection accuracy
- [ ] Spinning state detection accuracy
- [ ] Shift decision logic
- [ ] Transition phrase selection

### Integration Tests
- [ ] Mode shifts appear in conversation at right moments
- [ ] Mode history tracked correctly
- [ ] User override surfaces at ~10 messages

### Manual Testing
- [ ] Simulate defensive user - observe mode shift to encouraging
- [ ] Simulate overconfident user - observe pushback increase
- [ ] Simulate spinning user - observe grounding response

## Dependencies

- Story 6.1 must be complete (mode wiring)
- Story 6.3 (Kill Recommendations) builds on this

## Out of Scope

- Kill recommendation logic (Story 6.3)
- Viability scoring (Story 6.3)
- User-initiated mode control UI (Post-MVP)

## Notes

State detection should be lightweight - we're looking for clear signals, not subtle cues. False negatives are better than false positives (we'd rather miss a signal than shift incorrectly).

The transition phrases are crucial for UX - they make the shift feel natural rather than jarring.
