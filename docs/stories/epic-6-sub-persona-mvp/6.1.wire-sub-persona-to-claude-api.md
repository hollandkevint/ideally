# Story 6.1: Wire Sub-Persona to Claude API

**Status:** Ready
**Priority:** P0 - Critical Path
**Estimate:** 4-6 hours

## User Story

As a ThinkHaven user, I want the AI to respond with the appropriate sub-persona mode based on my session pathway, so that I receive structured pushback that matches my strategic need.

## Context

The sub-persona system has been implemented in `lib/ai/mary-persona.ts` with:
- Four modes: Inquisitive, Devil's Advocate, Encouraging, Realistic
- Pathway-weighted distributions
- Mode-specific prompt prefixes and behaviors

This story connects that logic to actual Claude API calls.

## Acceptance Criteria

1. **System prompt includes active mode**
   - Claude receives mode-specific instructions
   - Mode reflects pathway weights (New Idea = 40% Inquisitive, etc.)

2. **Mode context persists across messages**
   - Session tracks current mode
   - Mode influences response style

3. **Response reflects mode behavior**
   - Inquisitive: Open-ended questions, explores assumptions
   - Devil's Advocate: Challenges weak logic, probes blind spots
   - Encouraging: Validates good instincts, builds confidence
   - Realistic: Grounds in constraints, implementation feasibility

4. **Pathway weights applied**
   - New Idea: Inquisitive 40%, DA 20%, Encouraging 25%, Realistic 15%
   - Business Model: Inquisitive 20%, DA 35%, Encouraging 15%, Realistic 30%
   - Feature Refinement: Inquisitive 25%, DA 30%, Encouraging 15%, Realistic 30%

## Technical Implementation

### Files to Modify

1. **`lib/ai/claude-client.ts`**
   - Import sub-persona types from `mary-persona.ts`
   - Add `buildModeSystemPrompt(mode: SubPersonaMode)` function
   - Inject mode context into system prompt

2. **`lib/ai/mary-persona.ts`**
   - Export `getSystemPromptForMode(mode: SubPersonaMode): string`
   - Export `selectModeForMessage(pathway: PathwayType, messageIndex: number): SubPersonaMode`

3. **`app/api/chat/stream/route.ts`**
   - Pass pathway type to Claude client
   - Include mode in response metadata (for UI indicator)

4. **`app/api/chat/guest/route.ts`**
   - Same modifications for guest flow

### System Prompt Structure

```typescript
const modePrompts: Record<SubPersonaMode, string> = {
  inquisitive: `You are in INQUISITIVE mode. Your role is to dig deeper and understand context.
    - Ask open-ended questions to explore assumptions
    - Use "What if..." and "Tell me more about..." patterns
    - Don't challenge yet - build understanding first`,

  devils_advocate: `You are in DEVIL'S ADVOCATE mode. Your role is to challenge assumptions.
    - Push back on weak logic with specific questions
    - Probe blind spots: "What happens if X fails?"
    - Be direct but constructive in your challenges`,

  encouraging: `You are in ENCOURAGING mode. Your role is to validate good instincts.
    - Acknowledge strong thinking explicitly
    - Build on user's momentum
    - Still maintain strategic rigor - don't be sycophantic`,

  realistic: `You are in REALISTIC mode. Your role is to ground in constraints.
    - Bring up time/resource reality
    - Assess implementation feasibility
    - Help scope appropriately without deflating`
};
```

### Mode Selection Logic

```typescript
function selectModeForMessage(
  pathway: PathwayType,
  messageHistory: Message[],
  weights: ModeWeights
): SubPersonaMode {
  // Weighted random selection based on pathway
  const rand = Math.random();
  let cumulative = 0;

  for (const [mode, weight] of Object.entries(weights)) {
    cumulative += weight;
    if (rand <= cumulative) {
      return mode as SubPersonaMode;
    }
  }

  return 'inquisitive'; // Default fallback
}
```

## Testing

### Unit Tests
- [ ] Mode system prompt generation
- [ ] Pathway weight application
- [ ] Mode selection randomness within weights

### Integration Tests
- [ ] API returns mode in response metadata
- [ ] Different pathways produce different mode distributions (over 100 calls)

### Manual Testing
- [ ] New Idea pathway feels inquisitive-heavy
- [ ] Business Model pathway feels challenging
- [ ] Response style matches expected mode

## Dependencies

- Story 6.2 (Dynamic Shifting) builds on this
- No blockers

## Out of Scope

- Dynamic mode shifting (Story 6.2)
- Kill recommendations (Story 6.3)
- Mode indicator UI (Story 6.6)

## Notes

The mode should NOT be visible to users initially - they should just feel the difference in conversation style. Mode indicator UI comes later in Story 6.6.
