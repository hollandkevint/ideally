# Story 3.1: Framework Export - PDF & Markdown

## Status
âœ… Complete (2025-10-04)

## Implementation Priority
**Priority**: High
**Dependencies**: Story 2.4c (Feature Brief Generation - Basic exports implemented)
**Actual Effort**: 2 days
**Complexity**: Medium

## Story
**As a** user who has completed a coaching session with generated business frameworks,
**I want** professional-quality PDF export and easy markdown copying,
**so that** I can create polished documents for presentations and easily share content across platforms.

## Acceptance Criteria
1. **Professional PDF Export**: High-quality PDF generation with custom branding, formatting, and business presentation standards
2. **Markdown Copy**: One-click copy of framework content as formatted markdown for pasting into other tools

## Tasks / Subtasks

- [x] Task 1: Build Professional PDF Generation System (AC: 1)
  - [x] Subtask 1.1: Integrate PDF generation library (@react-pdf/renderer)
  - [x] Subtask 1.2: Design professional PDF templates for Feature Brief
  - [x] Subtask 1.3: Implement custom branding options (company name, colors)
  - [x] Subtask 1.4: Add formatting (page numbers, headers/footers)
  - [x] Subtask 1.5: Optimize PDF generation performance

- [x] Task 2: Implement Markdown Copy Functionality (AC: 2)
  - [x] Subtask 2.1: Enhance markdown formatter with GFM tables
  - [x] Subtask 2.2: Update "Copy as Markdown" button in export UI
  - [x] Subtask 2.3: Update clipboard API integration
  - [x] Subtask 2.4: Add visual copy success feedback
  - [x] Subtask 2.5: Add emojis and metadata for readability

- [x] Task 3: Integration & Testing (All ACs)
  - [x] Subtask 3.1: API endpoint updated for PDF binary response
  - [x] Subtask 3.2: Export UI updated for new formats
  - [x] Subtask 3.3: E2E tests created (feature-brief-export.test.ts)
  - [x] Subtask 3.4: Performance verified (PDF < 5 seconds)
  - [x] Subtask 3.5: Cross-browser support confirmed

## Dev Notes

### Previous Story Dependencies
**Extends Story 2.4c (Feature Brief Generation)**:
- Basic export functionality (Markdown, Text, PDF) already implemented
- Export formatters and client-side utilities available
- API endpoint pattern established (`export_feature_brief` action)
- Session state management for framework data

### Previous Story Integration Points
From Story 2.4c:
- `/apps/web/lib/bmad/exports/brief-formatters.ts` - Basic formatters to enhance
- `/apps/web/app/api/bmad/route.ts` - API endpoint to extend
- Export UI patterns and download functionality

### Library & Service Evaluation

**PDF Generation Options**:
1. **@react-pdf/renderer** (Recommended)
   - Pros: React-based, component-driven, client and server-side
   - Cons: Learning curve for PDF-specific components
   - Best for: Professional PDFs with React components

2. **jsPDF**
   - Pros: Lightweight, client-side generation, simple API
   - Cons: Limited formatting, more manual work
   - Best for: Simple PDFs with basic styling

**Markdown Formatting**:
- Use existing markdown formatters from Story 2.4c
- Enhance with better section headers and formatting
- Add GFM (GitHub Flavored Markdown) support for tables

### Data Models

**Export Configuration Schema** [Source: extending Story 2.4c export system]:
```sql
-- Enhanced export configuration
CREATE TABLE bmad_export_configs (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users not null,
  branding jsonb default '{}', -- Custom logo, colors, footer
  notion_workspace jsonb default '{}', -- Notion connection details
  airtable_bases jsonb default '{}', -- Airtable integration settings
  email_preferences jsonb default '{}', -- Email delivery settings
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Shareable URL management
CREATE TABLE bmad_shared_frameworks (
  id uuid default uuid_generate_v4() primary key,
  session_id uuid references bmad_sessions(id) on delete cascade,
  user_id uuid references auth.users not null,
  share_token text unique not null,
  framework_type text not null,
  access_level text check (access_level in ('view', 'comment', 'edit')) default 'view',
  expires_at timestamptz,
  view_count integer default 0,
  last_viewed_at timestamptz,
  revoked boolean default false,
  created_at timestamptz default now()
);

-- Export analytics tracking
CREATE TABLE bmad_export_events (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users not null,
  session_id uuid references bmad_sessions(id) on delete cascade,
  export_type text check (export_type in ('pdf', 'notion', 'airtable', 'csv', 'excel', 'email', 'share_url')) not null,
  format_details jsonb default '{}',
  success boolean not null,
  error_message text,
  file_size integer,
  generation_time interval,
  created_at timestamptz default now()
);
```

**Export Configuration Structure**:
```typescript
interface ExportConfiguration {
  userId: string;
  branding: BrandingOptions;
  integrations: IntegrationSettings;
  preferences: ExportPreferences;
}

interface BrandingOptions {
  logo?: string; // URL or base64
  primaryColor?: string;
  secondaryColor?: string;
  footer?: string;
  companyName?: string;
}

interface IntegrationSettings {
  notion?: NotionIntegration;
  airtable?: AirtableIntegration;
  email?: EmailSettings;
}

interface NotionIntegration {
  accessToken: string;
  workspaceId: string;
  defaultParentPageId?: string;
  connected: boolean;
}

interface AirtableIntegration {
  apiKey: string;
  baseId: string;
  tableNames: {
    featureBriefs?: string;
    leanCanvas?: string;
    businessModel?: string;
  };
  connected: boolean;
}

interface ShareableFramework {
  id: string;
  sessionId: string;
  shareToken: string;
  frameworkType: 'feature_brief' | 'lean_canvas' | 'business_model';
  accessLevel: 'view' | 'comment' | 'edit';
  expiresAt?: Date;
  viewCount: number;
  analytics: ShareAnalytics;
}
```

### API Specifications

**Advanced Export Endpoints** [Source: extending /api/bmad pattern]:
- `POST /api/bmad/export/pdf` - Generate professional PDF
- `POST /api/bmad/export/notion` - Export to Notion workspace
- `POST /api/bmad/export/airtable` - Export to Airtable base
- `POST /api/bmad/export/email` - Send via email
- `POST /api/bmad/export/share` - Generate shareable URL
- `GET /api/bmad/export/shared/:token` - Access shared framework
- `POST /api/bmad/export/config` - Save export configuration
- `GET /api/bmad/export/analytics` - Retrieve export analytics

**Export Service Architecture**:
```typescript
interface AdvancedExportService {
  // PDF Generation
  generateProfessionalPDF(framework: Framework, branding: BrandingOptions): Promise<Buffer>;

  // Notion Integration
  exportToNotion(framework: Framework, config: NotionIntegration): Promise<NotionPage>;

  // Airtable Integration
  exportToAirtable(framework: Framework, config: AirtableIntegration): Promise<AirtableRecord>;

  // Email Delivery
  sendViaEmail(framework: Framework, recipients: string[], format: ExportFormat): Promise<EmailResult>;

  // Shareable URLs
  generateShareURL(framework: Framework, options: ShareOptions): Promise<ShareableFramework>;

  // Analytics
  trackExportEvent(event: ExportEvent): Promise<void>;
  getExportAnalytics(userId: string, dateRange: DateRange): Promise<ExportAnalytics>;
}
```

### Component Specifications

**New Components Required**:
- `/apps/web/app/components/export/AdvancedExportModal.tsx` - Main export interface
- `/apps/web/app/components/export/PDFPreview.tsx` - PDF preview and customization
- `/apps/web/app/components/export/NotionConnector.tsx` - Notion integration setup
- `/apps/web/app/components/export/AirtableConnector.tsx` - Airtable integration setup
- `/apps/web/app/components/export/EmailDelivery.tsx` - Email sending interface
- `/apps/web/app/components/export/ShareLinkManager.tsx` - Shareable URL management
- `/apps/web/app/components/export/ExportAnalytics.tsx` - Export metrics dashboard
- `/apps/web/app/components/export/BrandingEditor.tsx` - Custom branding configuration

**Enhanced Components** [Source: extending Story 2.4c]:
- `/apps/web/app/components/bmad/pathways/ExportOptions.tsx` - Add advanced export options
- `/apps/web/lib/bmad/exports/brief-formatters.ts` - Enhance with professional templates

### File Locations

**New Files to Create**:
- `/apps/web/lib/export/pdf-generator.ts` - Professional PDF generation
- `/apps/web/lib/export/notion-client.ts` - Notion API integration
- `/apps/web/lib/export/airtable-client.ts` - Airtable API integration
- `/apps/web/lib/export/email-service.ts` - Email delivery service
- `/apps/web/lib/export/share-manager.ts` - Shareable URL management
- `/apps/web/lib/export/export-analytics.ts` - Export tracking and analytics
- `/apps/web/lib/export/templates/` - PDF templates directory

**Files to Modify**:
- `/apps/web/app/api/bmad/route.ts` - Add advanced export actions
- `/apps/web/lib/bmad/exports/brief-formatters.ts` - Enhance with professional formatting
- `/apps/web/lib/bmad/types.ts` - Add export configuration types

### Technical Implementation Details

**Professional PDF Generation**:
```typescript
// Puppeteer-based PDF generation
const generateProfessionalPDF = async (
  framework: Framework,
  branding: BrandingOptions
): Promise<Buffer> => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  const html = renderPDFTemplate(framework, branding);
  await page.setContent(html);

  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: { top: '20mm', right: '15mm', bottom: '20mm', left: '15mm' }
  });

  await browser.close();
  return pdf;
};
```

**Notion Integration**:
```typescript
// Notion API client
const exportToNotion = async (
  framework: FeatureBrief,
  config: NotionIntegration
): Promise<NotionPage> => {
  const notion = new Client({ auth: config.accessToken });

  const page = await notion.pages.create({
    parent: { page_id: config.defaultParentPageId },
    properties: {
      title: { title: [{ text: { content: framework.title } }] }
    },
    children: convertFrameworkToNotionBlocks(framework)
  });

  return page;
};

// Convert framework to Notion blocks
const convertFrameworkToNotionBlocks = (framework: FeatureBrief): Block[] => {
  return [
    { type: 'heading_1', heading_1: { rich_text: [{ text: { content: 'Description' } }] } },
    { type: 'paragraph', paragraph: { rich_text: [{ text: { content: framework.description } }] } },
    { type: 'heading_2', heading_2: { rich_text: [{ text: { content: 'User Stories' } }] } },
    ...framework.user_stories.map(story => ({
      type: 'bulleted_list_item',
      bulleted_list_item: { rich_text: [{ text: { content: story } }] }
    }))
  ];
};
```

**Airtable Integration**:
```typescript
// Airtable export
const exportToAirtable = async (
  framework: FeatureBrief,
  config: AirtableIntegration
): Promise<AirtableRecord> => {
  const base = new Airtable({ apiKey: config.apiKey }).base(config.baseId);

  const record = await base(config.tableNames.featureBriefs).create({
    'Title': framework.title,
    'Description': framework.description,
    'Priority': framework.priority_category,
    'User Stories': framework.user_stories.join('\n'),
    'Acceptance Criteria': framework.acceptance_criteria.join('\n'),
    'Created Date': new Date().toISOString()
  });

  return record;
};
```

**Email Delivery**:
```typescript
// Resend email integration
const sendViaEmail = async (
  framework: Framework,
  recipients: string[],
  format: ExportFormat
): Promise<EmailResult> => {
  const resend = new Resend(process.env.RESEND_API_KEY);

  const attachment = await generateExportFile(framework, format);

  const email = await resend.emails.send({
    from: 'ThinkHaven <frameworks@thinkhaven.co>',
    to: recipients,
    subject: `Your ${framework.type} Framework - ${framework.title}`,
    html: renderEmailTemplate(framework),
    attachments: [{
      filename: `${framework.title}-${format}.${getFileExtension(format)}`,
      content: attachment
    }]
  });

  return email;
};
```

**Shareable URL System**:
```typescript
// Generate secure shareable URL
const generateShareURL = async (
  framework: Framework,
  options: ShareOptions
): Promise<ShareableFramework> => {
  const shareToken = generateSecureToken();

  const shareRecord = await db.insert('bmad_shared_frameworks', {
    session_id: framework.sessionId,
    user_id: options.userId,
    share_token: shareToken,
    framework_type: framework.type,
    access_level: options.accessLevel || 'view',
    expires_at: options.expiresAt
  });

  const shareURL = `${process.env.APP_URL}/shared/${shareToken}`;

  return {
    ...shareRecord,
    url: shareURL
  };
};

// Public framework viewer
const getSharedFramework = async (token: string): Promise<Framework | null> => {
  const share = await db.findOne('bmad_shared_frameworks', {
    share_token: token,
    revoked: false
  });

  if (!share) return null;
  if (share.expires_at && new Date() > share.expires_at) return null;

  // Track view
  await db.update('bmad_shared_frameworks', share.id, {
    view_count: share.view_count + 1,
    last_viewed_at: new Date()
  });

  return await loadFrameworkData(share.session_id, share.framework_type);
};
```

### Performance Requirements

**Export Performance Standards** [Source: PRD NFR requirements]:
- PDF generation: <10 seconds
- Notion export: <5 seconds (excluding API latency)
- Airtable export: <3 seconds
- Email delivery: <5 seconds (queued)
- Share URL generation: <1 second
- Shared framework load: <2 seconds

### Security Considerations

**Shareable URL Security**:
- Cryptographically secure token generation (32+ bytes)
- Rate limiting for share access (10 requests/minute per IP)
- Optional expiration dates
- Revocation capability
- Access level enforcement (view/comment/edit)
- Audit logging for all access

**Integration Security**:
- OAuth tokens stored encrypted at rest
- API keys never exposed to client
- Secure credential rotation support
- Integration permission validation
- Rate limiting for external API calls

### Testing Requirements

**Testing Standards**:
- Unit tests: `/apps/web/tests/lib/export/`
- Integration tests: `/apps/web/tests/integration/export-integration.test.ts`
- E2E tests: `/apps/web/tests/e2e/advanced-export-workflows.test.ts`
- Security tests: `/apps/web/tests/security/export-security.test.ts`
- Coverage: Minimum 85% for export logic

**Specific Test Scenarios**:
- PDF generation with various frameworks and branding options
- Notion export with authentication and block conversion
- Airtable export with multiple framework types
- Email delivery with attachments and error handling
- Shareable URL generation, access, and expiration
- Export analytics tracking accuracy
- Integration error handling and retry logic
- Security testing for shareable URLs and access controls

### Analytics & Monitoring

**Export Analytics Metrics**:
- Export volume by format (PDF, Notion, Airtable, etc.)
- Export success/failure rates
- Average generation time per format
- User preferences and adoption rates
- Shareable URL engagement (views, downloads)
- Integration usage patterns

**Monitoring & Alerts**:
- Export failure rate threshold alerts
- External API downtime detection
- Performance degradation alerts
- Security anomaly detection (unusual share access patterns)

## Testing

### Testing Standards
- **Test Location**: `/apps/web/tests/lib/export/`
- **Integration Tests**: `/apps/web/tests/integration/`
- **E2E Tests**: `/apps/web/tests/e2e/` with Playwright
- **Security Tests**: `/apps/web/tests/security/`
- **Coverage**: Minimum 85% code coverage for export logic

### Specific Testing Requirements
- Professional PDF generation with custom branding
- Notion API integration with authentication flow
- Airtable export with multiple framework types
- Email delivery with attachment handling
- Shareable URL generation and access control
- Export analytics tracking and dashboard display
- Performance testing under concurrent export load
- Security testing for URL access and token validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation - Advanced export system extending Story 2.4c basic exports | Bob (Scrum Master) |

## Implementation Plan

### Phase 1: Professional PDF Generation (Day 1)
**Files to Create:**
- `lib/export/pdf-generator.ts` - Puppeteer-based PDF generation
- `lib/export/templates/feature-brief-pdf.tsx` - React PDF template
- `app/components/export/PDFPreview.tsx` - PDF preview component

**Key Features:**
- Professional PDF templates
- Custom branding support
- Advanced formatting (TOC, page numbers)

### Phase 2: Notion Integration (Day 1-2)
**Files to Create:**
- `lib/export/notion-client.ts` - Notion API wrapper
- `app/components/export/NotionConnector.tsx` - OAuth flow and setup

**Key Functions:**
```typescript
async function connectNotionWorkspace(code: string): Promise<NotionIntegration>
async function exportToNotion(framework: Framework, config: NotionIntegration): Promise<NotionPage>
function convertFrameworkToNotionBlocks(framework: Framework): Block[]
```

### Phase 3: Airtable & Spreadsheet Export (Day 2-3)
**Files to Create:**
- `lib/export/airtable-client.ts`
- `lib/export/spreadsheet-exporter.ts` (CSV/Excel)
- `app/components/export/AirtableConnector.tsx`

**Export Formats:**
- Airtable records
- CSV with UTF-8 encoding
- Excel with multiple sheets

### Phase 4: Email Delivery & Shareable URLs (Day 3-4)
**Files to Create:**
- `lib/export/email-service.ts` - Resend integration
- `lib/export/share-manager.ts` - URL generation and access control
- `app/components/export/EmailDelivery.tsx`
- `app/components/export/ShareLinkManager.tsx`
- `app/shared/[token]/page.tsx` - Public viewer

**Key Features:**
- Email templates with framework previews
- Secure token generation
- Access level management
- View tracking and analytics

### Phase 5: Export Analytics (Day 4-5)
**Files to Create:**
- `lib/export/export-analytics.ts`
- `app/components/export/ExportAnalytics.tsx`

**Analytics Features:**
- Export event tracking
- Format preference analysis
- Success/failure monitoring
- User engagement metrics

### Phase 6: Testing & Integration (Day 5)
**Testing:**
- Unit tests for all export services
- Integration tests for external APIs
- E2E tests for complete workflows
- Security testing for shareable URLs

**Integration:**
- Enhance Story 2.4c ExportOptions component
- Update API endpoints
- Add analytics dashboard to user settings

## Dev Agent Record

### Implementation Checklist
- [ ] Professional PDF generation with Puppeteer
- [ ] Custom branding configuration (logo, colors, footer)
- [ ] PDF templates for all framework types
- [ ] Notion OAuth integration
- [ ] Notion API client and block conversion
- [ ] Airtable API integration
- [ ] CSV export functionality
- [ ] Excel export with multiple sheets
- [ ] Email service integration (Resend)
- [ ] Email templates with framework previews
- [ ] Secure shareable URL generation
- [ ] Public framework viewer page
- [ ] Access control and permission management
- [ ] URL expiration and revocation
- [ ] Export analytics tracking
- [ ] Analytics dashboard
- [ ] Unit tests (85%+ coverage)
- [ ] Integration tests for external APIs
- [ ] E2E tests for export workflows
- [ ] Security tests for shareable URLs

### Technical Notes
**PDF Generation:**
- Primary: Puppeteer (professional quality)
- Fallback: jsPDF (if Puppeteer too heavy)
- Templates: React components converted to HTML

**Email Service:**
- Primary: Resend (modern, React email templates)
- Backup: SendGrid or AWS SES if needed

**Security:**
- 32-byte secure tokens
- Rate limiting on share access
- Encrypted credential storage
- Audit logging for access

## QA Results

*This section will be populated by the QA Agent upon story completion*