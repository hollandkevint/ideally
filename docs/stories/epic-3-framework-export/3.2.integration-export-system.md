# Story 3.2: Framework Export - Advanced Integrations

## Status
Future - Blocked by Story 3.1

## Implementation Priority
**Priority**: Medium
**Dependencies**: Story 3.1 (PDF & Markdown Export)
**Estimated Effort**: 3-4 days
**Complexity**: High

## Story
**As a** user who has completed a coaching session with generated business frameworks,
**I want** to export my frameworks directly to productivity tools and share them securely,
**so that** I can seamlessly integrate strategic outputs into my existing workflows and collaborate with team members.

## Acceptance Criteria
1. **Notion Integration**: Direct export to Notion workspaces with proper page hierarchy and formatting
2. **Airtable/Spreadsheet Export**: Structured data export to Airtable and CSV/Excel formats for analysis
3. **Email Delivery**: Automated email delivery with attachment options and formatting preservation
4. **Shareable URLs**: Generate unique, secure URLs for sharing frameworks with team members or stakeholders
5. **Export Analytics**: Track export usage patterns, format preferences, and sharing metrics

## Tasks / Subtasks

- [ ] Task 1: Implement Notion API Integration (AC: 1)
  - [ ] Subtask 1.1: Set up Notion API authentication and workspace connection
  - [ ] Subtask 1.2: Create Notion page templates for different framework types
  - [ ] Subtask 1.3: Implement framework-to-Notion conversion with proper block formatting
  - [ ] Subtask 1.4: Add workspace selection and page hierarchy management
  - [ ] Subtask 1.5: Handle Notion API rate limiting and error recovery

- [ ] Task 2: Build Airtable & Spreadsheet Export (AC: 2)
  - [ ] Subtask 2.1: Set up Airtable API integration and base management
  - [ ] Subtask 2.2: Create Airtable table templates for structured framework data
  - [ ] Subtask 2.3: Implement CSV export with proper formatting and encoding
  - [ ] Subtask 2.4: Add Excel (.xlsx) export with multiple sheets and formatting
  - [ ] Subtask 2.5: Create data mapping logic for different framework types

- [ ] Task 3: Develop Email Delivery System (AC: 3)
  - [ ] Subtask 3.1: Integrate email service (Resend or SendGrid)
  - [ ] Subtask 3.2: Design professional email templates with framework previews
  - [ ] Subtask 3.3: Implement attachment handling for multiple formats
  - [ ] Subtask 3.4: Add email delivery tracking and confirmation
  - [ ] Subtask 3.5: Create bulk email functionality for team sharing

- [ ] Task 4: Create Shareable URL System (AC: 4)
  - [ ] Subtask 4.1: Design URL generation and secure token system
  - [ ] Subtask 4.2: Create public framework viewer page with access controls
  - [ ] Subtask 4.3: Implement permission management (view, comment, edit)
  - [ ] Subtask 4.4: Add URL analytics tracking (views, downloads, shares)
  - [ ] Subtask 4.5: Create URL expiration and revocation functionality

- [ ] Task 5: Build Export Analytics Dashboard (AC: 5)
  - [ ] Subtask 5.1: Create export event tracking system
  - [ ] Subtask 5.2: Design analytics dashboard for export metrics
  - [ ] Subtask 5.3: Implement format preference analysis
  - [ ] Subtask 5.4: Add sharing and collaboration metrics
  - [ ] Subtask 5.5: Create export success/failure monitoring

- [ ] Task 6: Integration & Testing (All ACs)
  - [ ] Subtask 6.1: Unit tests for all integrations
  - [ ] Subtask 6.2: Integration tests for external API connections
  - [ ] Subtask 6.3: E2E tests for complete workflows
  - [ ] Subtask 6.4: Performance testing under load
  - [ ] Subtask 6.5: Security testing for shareable URLs and access controls

## Dev Notes

### Dependencies from Story 3.1
**Requires Story 3.1 Completion**:
- PDF generation infrastructure
- Markdown formatting utilities
- Export UI patterns and components
- Base export system architecture

### Library & Service Evaluation

**Email Service Options**:
1. **Resend** (Recommended)
   - Pros: Modern API, React email templates, analytics
   - Cons: Newer service
   - Best for: Developer-friendly email delivery

2. **SendGrid**
   - Pros: Mature, robust, comprehensive features
   - Cons: More complex pricing
   - Best for: Enterprise-grade email

**Integration APIs**:
- Notion SDK: `@notionhq/client`
- Airtable SDK: `airtable`
- Excel generation: `exceljs`

### Data Models

**Export Configuration Schema**:
```sql
-- Enhanced export configuration
CREATE TABLE bmad_export_configs (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users not null,
  notion_workspace jsonb default '{}', -- Notion connection details
  airtable_bases jsonb default '{}', -- Airtable integration settings
  email_preferences jsonb default '{}', -- Email delivery settings
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Shareable URL management
CREATE TABLE bmad_shared_frameworks (
  id uuid default uuid_generate_v4() primary key,
  session_id uuid references bmad_sessions(id) on delete cascade,
  user_id uuid references auth.users not null,
  share_token text unique not null,
  framework_type text not null,
  access_level text check (access_level in ('view', 'comment', 'edit')) default 'view',
  expires_at timestamptz,
  view_count integer default 0,
  last_viewed_at timestamptz,
  revoked boolean default false,
  created_at timestamptz default now()
);

-- Export analytics tracking
CREATE TABLE bmad_export_events (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users not null,
  session_id uuid references bmad_sessions(id) on delete cascade,
  export_type text check (export_type in ('pdf', 'markdown', 'notion', 'airtable', 'csv', 'excel', 'email', 'share_url')) not null,
  format_details jsonb default '{}',
  success boolean not null,
  error_message text,
  file_size integer,
  generation_time interval,
  created_at timestamptz default now()
);
```

### API Specifications

**Advanced Export Endpoints**:
- `POST /api/bmad/export/notion` - Export to Notion workspace
- `POST /api/bmad/export/airtable` - Export to Airtable base
- `POST /api/bmad/export/email` - Send via email
- `POST /api/bmad/export/share` - Generate shareable URL
- `GET /api/bmad/export/shared/:token` - Access shared framework
- `POST /api/bmad/export/config` - Save export configuration
- `GET /api/bmad/export/analytics` - Retrieve export analytics

### File Locations

**New Files to Create**:
- `/apps/web/lib/export/notion-client.ts` - Notion API integration
- `/apps/web/lib/export/airtable-client.ts` - Airtable API integration
- `/apps/web/lib/export/email-service.ts` - Email delivery service
- `/apps/web/lib/export/share-manager.ts` - Shareable URL management
- `/apps/web/lib/export/export-analytics.ts` - Export tracking and analytics
- `/apps/web/app/components/export/NotionConnector.tsx` - Notion OAuth flow
- `/apps/web/app/components/export/AirtableConnector.tsx` - Airtable setup
- `/apps/web/app/components/export/EmailDelivery.tsx` - Email sending interface
- `/apps/web/app/components/export/ShareLinkManager.tsx` - URL management
- `/apps/web/app/components/export/ExportAnalytics.tsx` - Analytics dashboard

**Files to Extend from Story 3.1**:
- `/apps/web/app/api/bmad/route.ts` - Add integration endpoints
- Export modal components - Add integration options

### Security Considerations

**Shareable URL Security**:
- Cryptographically secure token generation (32+ bytes)
- Rate limiting for share access (10 requests/minute per IP)
- Optional expiration dates
- Revocation capability
- Access level enforcement (view/comment/edit)
- Audit logging for all access

**Integration Security**:
- OAuth tokens stored encrypted at rest
- API keys never exposed to client
- Secure credential rotation support
- Integration permission validation
- Rate limiting for external API calls

### Performance Requirements

**Integration Performance Standards**:
- Notion export: <5 seconds (excluding API latency)
- Airtable export: <3 seconds
- Email delivery: <5 seconds (queued)
- Share URL generation: <1 second
- Shared framework load: <2 seconds

### Testing Requirements

**Testing Standards**:
- Unit tests: `/apps/web/tests/lib/export/`
- Integration tests: `/apps/web/tests/integration/export-integration.test.ts`
- E2E tests: `/apps/web/tests/e2e/advanced-export-workflows.test.ts`
- Security tests: `/apps/web/tests/security/export-security.test.ts`
- Coverage: Minimum 85% for integration logic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-04 | 1.0 | Created Story 3.2 from original Story 3.1 advanced features | Development Team |

## QA Results

*This section will be populated by the QA Agent upon story completion*
