#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for secrets using git diff
echo "Scanning for potential secrets..."

# Patterns to detect
PATTERNS=(
  'sk-ant-[a-zA-Z0-9\-]{95}'  # Anthropic API keys
  'sk-[a-zA-Z0-9]{48}'         # OpenAI API keys
  'sbp_[a-zA-Z0-9]{40}'        # Supabase service keys
  'eyJ[a-zA-Z0-9_\-]*\.eyJ'    # JWT tokens
  'BEGIN.*PRIVATE KEY'         # Private keys
  'password.*[:=].*["\047]'    # Passwords in config
  'api[_-]?key.*[:=].*["\047]' # API keys
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  for pattern in "${PATTERNS[@]}"; do
    # Check each staged file for the pattern
    for file in $STAGED_FILES; do
      if git diff --cached "$file" | grep -qE "$pattern"; then
        echo "‚ùå SECURITY ERROR: Potential secret detected in $file"
        echo "   Pattern matched: $pattern"
        echo ""
        echo "   Please remove sensitive data before committing."
        echo "   If this is a false positive, you can bypass with: git commit --no-verify"
        exit 1
      fi
    done
  done
fi

echo "‚úÖ No secrets detected in staged files"

# Run existing pre-commit checks if they exist
if [ -f "package.json" ]; then
  # Check if lint-staged is configured
  if grep -q "lint-staged" package.json; then
    npx lint-staged
  fi
fi