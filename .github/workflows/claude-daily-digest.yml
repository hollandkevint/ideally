name: Claude Daily Digest

on:
  schedule:
    # Run daily at 9 AM UTC (4 AM EST / 1 AM PST)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back'
        required: false
        default: '1'

jobs:
  daily-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Gather recent activity
        id: activity
        run: |
          DAYS="${{ github.event.inputs.days_back || '1' }}"
          SINCE=$(date -d "$DAYS days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -v-${DAYS}d +%Y-%m-%dT%H:%M:%SZ)

          echo "since=$SINCE" >> $GITHUB_OUTPUT

          # Recent commits
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          git log --since="$SINCE" --oneline --no-merges | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Changed files summary
          echo "files_changed<<EOF" >> $GITHUB_OUTPUT
          git diff --stat HEAD~10 HEAD 2>/dev/null | tail -10 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get open issues and PRs
        id: github-data
        uses: actions/github-script@v7
        with:
          script: |
            const since = new Date();
            since.setDate(since.getDate() - 1);

            // Get open PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 10
            });

            // Get recent issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              since: since.toISOString(),
              per_page: 10
            });

            // Get failed workflow runs
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'failure',
              per_page: 5
            });

            const summary = {
              openPRs: prs.map(pr => `#${pr.number}: ${pr.title}`).join('\n'),
              openIssues: issues.filter(i => !i.pull_request).map(i => `#${i.number}: ${i.title}`).join('\n'),
              failedRuns: runs.workflow_runs.map(r => `${r.name}: ${r.conclusion}`).join('\n')
            };

            core.setOutput('open_prs', summary.openPRs || 'None');
            core.setOutput('open_issues', summary.openIssues || 'None');
            core.setOutput('failed_runs', summary.failedRuns || 'None');

      - name: Claude Daily Digest
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Generate a concise daily development digest for ThinkHaven MVP.

            ## Recent Commits
            ${{ steps.activity.outputs.commits }}

            ## Files Changed
            ${{ steps.activity.outputs.files_changed }}

            ## Open PRs
            ${{ steps.github-data.outputs.open_prs }}

            ## Open Issues
            ${{ steps.github-data.outputs.open_issues }}

            ## Failed Workflows
            ${{ steps.github-data.outputs.failed_runs }}

            Create a digest with:
            1. **Summary** - One paragraph on what happened
            2. **MVP Blockers** - Issues blocking launch
            3. **Action Items** - What needs attention today
            4. **Build Health** - Quick status on tests/deploys

            Keep it scannable. Kevin is trying to ship an MVP.
          claude_args: "--max-turns 2"

      - name: Create digest issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];

            // Check if digest already exists for today
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'daily-digest',
              state: 'open'
            });

            const todayDigest = existing.find(i => i.title.includes(today));
            if (todayDigest) {
              console.log('Digest already exists for today');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Digest - ${today}`,
              body: 'Claude Daily Digest is processing... Check the workflow run for details.',
              labels: ['daily-digest', 'automated']
            });
